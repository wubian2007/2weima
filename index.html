<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>快捷支付 - 手机端</title>
  <style>
    :root{--bg:#0b0b0b;--btn-height:58px;--accent:#ff6b00}
    html,body{height:100%;margin:0;font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "PingFang SC", "Hiragino Sans GB", "Microsoft Yahei", Arial; background:var(--bg); color:#fff}
    .page{min-height:100vh;display:flex;flex-direction:column}

    /* 顶部信息栏 */
    .header{background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);padding:20px;text-align:center;color:#fff}
    .header-title{font-size:24px;font-weight:bold;margin-bottom:10px}
    .header-info{display:flex;justify-content:space-around;align-items:center;font-size:14px}
    .info-item{display:flex;flex-direction:column;align-items:center}
    .info-label{opacity:0.8;margin-bottom:4px}
    .info-value{font-weight:600}

    /* 图片区域 - 移除边框，全屏显示 */
    .hero{flex:1;display:flex;align-items:center;justify-content:center;padding:0;position:relative}
    .guide-img{width:100%;height:100%;object-fit:contain;display:block}

    /* 倒计时器 - 移到图片上方 */
    .countdown{position:absolute;top:20px;right:20px;background:rgba(255,0,0,0.8);color:#fff;padding:8px 16px;border-radius:20px;font-size:16px;font-weight:600;z-index:100}
    .countdown.expired{background:rgba(255,0,0,0.6);color:#ffcccc}

    /* 扫码支付提示 - 移到图片上方 */
    .hint{position:absolute;left:20px;top:20px;background:rgba(0,0,0,0.7);color:#fff;padding:8px 16px;border-radius:20px;font-size:16px;font-weight:600;z-index:100}

    /* 过期提示 */
    .expired-overlay{position:absolute;inset:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:50}
    .expired-overlay.show{display:flex}
    .expired-content{text-align:center;color:#fff}
    .expired-title{font-size:20px;font-weight:600;margin-bottom:12px}
    .expired-desc{font-size:16px;opacity:0.8;margin-bottom:20px}

    /* 底部按钮 */
    .footer{padding:12px;display:flex;gap:12px;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,0.35))}
    .btn{flex:1;max-width:360px;height:var(--btn-height);border-radius:10px;border:0;font-size:18px;font-weight:600;display:inline-flex;align-items:center;justify-content:center;gap:8px}
    .btn.primary{background:var(--accent);color:#fff;box-shadow:0 6px 18px rgba(255,107,0,0.18)}
    .btn.ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.08)}
  </style>
</head>
<body>
  <div class="page">
    <!-- 顶部信息栏 -->
    <header class="header">
      <div class="header-title">快捷支付</div>
      <div class="header-info">
        <div class="info-item">
          <div class="info-label">支付金额</div>
          <div class="info-value" id="paymentAmount">100-2000</div>
        </div>
        <div class="info-item">
          <div class="info-label">有效期</div>
          <div class="info-value" id="validityPeriod">100秒</div>
        </div>
      </div>
    </header>

    <main class="hero">
      <!-- 倒计时器 -->
      <div class="countdown" id="countdown">
        <span id="countdownText">100s</span>
      </div>

      <!-- 扫码支付提示 -->
      <div class="hint" id="scanHint">扫码支付</div>

      <!-- 图片，使用base64数据或后台配置的地址 -->
      <img id="guideImage" class="guide-img" src="" alt="收款引导图" />

      <!-- 过期提示覆盖层 -->
      <div class="expired-overlay" id="expiredOverlay">
        <div class="expired-content">
          <div class="expired-title">二维码已过期</div>
          <div class="expired-desc">点击刷新</div>
        </div>
      </div>
    </main>

    <footer class="footer">
      <button id="reloadBtn" class="btn ghost">刷新二维码</button>
      <button id="forceUpdateBtn" class="btn ghost" onclick="forceUpdateImage()">强制更新</button>
      <button id="payBtn" class="btn primary">立即支付</button>
    </footer>
  </div>

  <!-- 引入base64图片数据 -->
  <script src="image-base64.js"></script>
  <!-- 引入多域名管理功能 -->
  <script src="multi-domain-manager.js"></script>
  <!-- 引入自动跳转功能 -->
  <script src="auto-redirect-manager.js"></script>

  <script>
    // 配置 - 从localStorage加载或使用默认值
    const DEFAULT_CONFIG = {
      countdownSeconds: 100,
      paymentAmount: '100-2000',
      validityPeriod: '100秒',
      scanHint: '扫码支付'
    };
    
    // 加载配置
    function loadConfig() {
      const config = {};
      Object.keys(DEFAULT_CONFIG).forEach(key => {
        const saved = localStorage.getItem(key);
        config[key] = saved !== null ? saved : DEFAULT_CONFIG[key];
      });
      return config;
    }
    
    // 应用配置到界面
    function applyConfig(config) {
      document.getElementById('paymentAmount').textContent = config.paymentAmount;
      document.getElementById('validityPeriod').textContent = config.validityPeriod;
      document.getElementById('scanHint').textContent = config.scanHint;
      return config.countdownSeconds;
    }
    
    const config = loadConfig();
    const COUNTDOWN_SECONDS = applyConfig(config);
    
    // DOM元素
    const guideImage = document.getElementById('guideImage');
    const reloadBtn = document.getElementById('reloadBtn');
    const payBtn = document.getElementById('payBtn');
    const countdown = document.getElementById('countdown');
    const countdownText = document.getElementById('countdownText');
    const expiredOverlay = document.getElementById('expiredOverlay');

    // 设置图片源
    function setImageSource() {
      console.log('setImageSource 被调用');
      
      // 优先使用后台配置的图片地址
      const imageUrl = localStorage.getItem('imageUrl');
      console.log('从localStorage获取的imageUrl:', imageUrl);
      
      if (imageUrl && imageUrl.trim()) {
        console.log('设置图片地址:', imageUrl.trim());
        
        // 添加时间戳防止缓存
        const imageUrlWithTimestamp = imageUrl.trim() + '?t=' + Date.now();
        guideImage.src = imageUrlWithTimestamp;
        
        // 添加图片加载事件监听
        guideImage.onload = function() {
          console.log('图片加载成功:', this.src);
          showStatus('图片加载成功！', 'success');
        };
        
        guideImage.onerror = function() {
          console.log('图片加载失败:', this.src);
          showStatus('图片加载失败！', 'error');
          
          // 如果加载失败，尝试不带时间戳的URL
          if (this.src.includes('?t=')) {
            console.log('尝试不带时间戳的URL');
            this.src = imageUrl.trim();
          }
        };
        
        return;
      }

      // 如果没有配置图片地址，使用base64图片
      if (window.IMAGE_BASE64) {
        console.log('使用Base64图片');
        guideImage.src = window.IMAGE_BASE64;
      } else {
        // 如果base64文件加载失败，使用备用图片
        console.log('使用备用图片');
        guideImage.src = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="800" height="400"><rect fill="#222" width="100%" height="100%"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#999" font-size="20">图片加载失败，点击刷新二维码</text></svg>');
      }
    }
    
    // 长按图片功能
    let longPressTimer = null;
    let isLongPressed = false;
    
    function startLongPress() {
      if (longPressTimer) return;
      
      longPressTimer = setTimeout(() => {
        isLongPressed = true;
        showLongPressMenu();
      }, 3000); // 3秒长按
    }
    
    function cancelLongPress() {
      if (longPressTimer) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
      }
      isLongPressed = false;
    }
    
    function showLongPressMenu() {
      // 创建微信风格的长按菜单
      const menu = document.createElement('div');
      menu.id = 'longPressMenu';
      menu.innerHTML = `
        <div style="
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.5);
          z-index: 1000;
          display: flex;
          align-items: center;
          justify-content: center;
        ">
          <div style="
            background: #333;
            border-radius: 12px;
            padding: 20px;
            max-width: 300px;
            width: 90%;
          ">
            <div style="
              color: #fff;
              text-align: center;
              font-size: 18px;
              margin-bottom: 20px;
            ">选择操作</div>
            <div style="
              display: flex;
              flex-direction: column;
              gap: 10px;
            ">
              <button onclick="saveImage()" style="
                background: #007aff;
                color: #fff;
                border: none;
                padding: 12px;
                border-radius: 8px;
                font-size: 16px;
              ">保存图片</button>
              <button onclick="copyImageUrl()" style="
                background: #007aff;
                color: #fff;
                border: none;
                padding: 12px;
                border-radius: 8px;
                font-size: 16px;
              ">复制图片链接</button>
              <button onclick="closeLongPressMenu()" style="
                background: #666;
                color: #fff;
                border: none;
                padding: 12px;
                border-radius: 8px;
                font-size: 16px;
              ">取消</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(menu);
    }
    
    function closeLongPressMenu() {
      const menu = document.getElementById('longPressMenu');
      if (menu) {
        menu.remove();
      }
      cancelLongPress();
    }
    
    function saveImage() {
      // 创建下载链接
      const link = document.createElement('a');
      link.href = guideImage.src;
      link.download = 'payment-qr.png';
      link.click();
      closeLongPressMenu();
    }
    
    function copyImageUrl() {
      // 复制图片URL到剪贴板
      navigator.clipboard.writeText(guideImage.src).then(() => {
        alert('图片链接已复制到剪贴板');
      }).catch(() => {
        alert('复制失败，请手动复制');
      });
      closeLongPressMenu();
    }
    
    // 绑定长按事件
    guideImage.addEventListener('mousedown', startLongPress);
    guideImage.addEventListener('mouseup', cancelLongPress);
    guideImage.addEventListener('mouseleave', cancelLongPress);
    guideImage.addEventListener('touchstart', startLongPress);
    guideImage.addEventListener('touchend', cancelLongPress);
    guideImage.addEventListener('touchcancel', cancelLongPress);

    // 倒计时相关变量
    let countdownTimer = null;
    let remainingSeconds = COUNTDOWN_SECONDS;
    let isExpired = false;

    // 初始化倒计时
    function initCountdown() {
      // 从localStorage读取倒计时配置和保存时间
      const savedCountdown = localStorage.getItem('countdownSeconds');
      const saveTime = localStorage.getItem('configSaveTime');
      
      if (savedCountdown && saveTime) {
        // 计算从保存时间开始的剩余时间
        const elapsed = Math.floor((Date.now() - parseInt(saveTime)) / 1000);
        remainingSeconds = parseInt(savedCountdown) - elapsed;
        
        if (remainingSeconds <= 0) {
          // 已过期
          remainingSeconds = 0;
          isExpired = true;
          handleExpired();
          return;
        }
      } else {
        // 没有保存时间，使用默认倒计时
        remainingSeconds = savedCountdown ? parseInt(savedCountdown) : COUNTDOWN_SECONDS;
      }
      
      isExpired = false;
      updateCountdownDisplay();
      startCountdown();
    }

    // 开始倒计时
    function startCountdown() {
      if (countdownTimer) clearInterval(countdownTimer);
      
      countdownTimer = setInterval(() => {
        remainingSeconds--;
        updateCountdownDisplay();
        
        if (remainingSeconds <= 0) {
          clearInterval(countdownTimer);
          handleExpired();
        }
      }, 1000);
    }

    // 更新倒计时显示
    function updateCountdownDisplay() {
      const minutes = Math.floor(remainingSeconds / 60);
      const seconds = remainingSeconds % 60;
      countdownText.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      // 当剩余时间少于30秒时，改变颜色
      if (remainingSeconds <= 30) {
        countdown.classList.add('expired');
      } else {
        countdown.classList.remove('expired');
      }
    }

    // 处理过期
    function handleExpired() {
      isExpired = true;
      expiredOverlay.classList.add('show');
      countdown.classList.add('expired');
      countdownText.textContent = '已过期';
      
      // 禁用支付按钮
      payBtn.disabled = true;
      payBtn.style.opacity = '0.5';
      
      // 更新刷新按钮文本
      reloadBtn.textContent = '刷新二维码';
      
      // 更新过期提示文本
      const expiredDesc = document.querySelector('.expired-desc');
      if (expiredDesc) {
        expiredDesc.textContent = '点击刷新';
      }
    }

    // 刷新二维码功能 - 带图片更新检测
    function refreshQRCode() {
      console.log('刷新二维码被调用');
      
      // 清除过期状态
      isExpired = false;
      expiredOverlay.classList.remove('show');
      countdown.classList.remove('expired');
      
      // 重新启用支付按钮
      payBtn.disabled = false;
      payBtn.style.opacity = '1';
      
      // 保存当前图片URL用于比较
      const currentImageUrl = guideImage.src;
      console.log('当前图片URL:', currentImageUrl);
      
      // 显示刷新提示
      showStatus('正在刷新二维码...', 'info');
      
      // 强制清除图片缓存
      guideImage.src = '';
      
      // 重新加载图片
      setImageSource();
      
      // 检测图片是否更新
      setTimeout(() => {
        const newImageUrl = guideImage.src;
        console.log('新图片URL:', newImageUrl);
        if (newImageUrl === currentImageUrl) {
          showStatus('二维码未更新，请稍后再试', 'warning');
        } else {
          showStatus('二维码已更新！', 'success');
        }
      }, 1000);
      
      // 重新初始化倒计时
      initCountdown();
    }

    // 支付按钮点击事件 - 自动执行长按操作
    function handlePayClick() {
      if (isExpired) {
        alert('二维码已过期，请刷新二维码');
        return;
      }
      
      // 自动执行长按操作
      console.log('立即支付按钮被点击，执行长按操作...');
      startLongPress();
    }

    // 绑定事件
    reloadBtn.addEventListener('click', refreshQRCode);
    payBtn.addEventListener('click', handlePayClick);

    // 显示状态提示
    function showStatus(message, type) {
      // 创建状态提示元素
      const statusDiv = document.createElement('div');
      statusDiv.id = 'statusMessage';
      
      // 根据类型设置样式
      let bgColor = '#333';
      let textColor = '#fff';
      
      switch(type) {
        case 'success':
          bgColor = '#28a745';
          break;
        case 'error':
          bgColor = '#dc3545';
          break;
        case 'warning':
          bgColor = '#ffc107';
          textColor = '#333';
          break;
        case 'info':
          bgColor = '#17a2b8';
          break;
      }
      
      statusDiv.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: ${bgColor};
        color: ${textColor};
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        z-index: 2000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        transition: all 0.3s ease;
      `;
      
      statusDiv.textContent = message;
      
      // 移除已存在的状态提示
      const existingStatus = document.getElementById('statusMessage');
      if (existingStatus) {
        existingStatus.remove();
      }
      
      // 添加到页面
      document.body.appendChild(statusDiv);
      
      // 3秒后自动移除
      setTimeout(() => {
        if (statusDiv.parentNode) {
          statusDiv.style.opacity = '0';
          statusDiv.style.transform = 'translateX(-50%) translateY(-20px)';
          setTimeout(() => {
            if (statusDiv.parentNode) {
              statusDiv.remove();
            }
          }, 300);
        }
      }, 3000);
      
      // 同时输出到控制台
      console.log(`${type}: ${message}`);
    }

    // 图片加载错误处理
    guideImage.addEventListener('error', ()=>{
      guideImage.src = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="800" height="400"><rect fill="#222" width="100%" height="100%"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#999" font-size="20">图片加载失败，点击刷新二维码</text></svg>');
    });

    // 监听localStorage变化，实时更新图片和倒计时
    window.addEventListener('storage', (e) => {
      if (e.key === 'imageUrl' || e.key === 'countdownSeconds' || e.key === 'configSaveTime') {
        if (e.key === 'imageUrl') {
          setImageSource();
        }
        if (e.key === 'countdownSeconds' || e.key === 'configSaveTime') {
          // 重新初始化倒计时
          initCountdown();
        }
      }
    });
    
    // 监听自定义事件，实时更新图片（同一窗口内的更新）
    window.addEventListener('imageUrlUpdated', (e) => {
      console.log('收到图片更新事件:', e.detail);
      console.log('事件详情:', e);
      setImageSource();
      showStatus('图片已实时更新！', 'success');
    });
    
    // 监听页面配置更新事件
    window.addEventListener('pageConfigUpdated', (e) => {
      console.log('收到页面配置更新事件:', e.detail);
      const config = e.detail;
      
      // 更新页面配置
      document.getElementById('paymentAmount').textContent = config.paymentAmount;
      document.getElementById('validityPeriod').textContent = config.validityPeriod;
      document.getElementById('scanHint').textContent = config.scanHint;
      
      // 重新初始化倒计时
      initCountdown();
      
      showStatus('页面配置已实时更新！', 'success');
    });
    
    // 强制更新图片功能
    function forceUpdateImage() {
      console.log('强制更新图片被调用');
      
      // 显示更新提示
      showStatus('正在强制更新图片...', 'info');
      
      // 清除localStorage中的图片缓存
      const imageUrl = localStorage.getItem('imageUrl');
      console.log('当前localStorage中的图片地址:', imageUrl);
      
      // 强制清除图片缓存
      guideImage.src = '';
      
      // 重新设置图片
      if (imageUrl && imageUrl.trim()) {
        console.log('强制设置图片地址:', imageUrl.trim());
        guideImage.src = imageUrl.trim() + '?t=' + Date.now(); // 添加时间戳防止缓存
      } else {
        console.log('localStorage中没有图片地址，使用默认图片');
        setImageSource();
      }
      
      // 显示成功提示
      setTimeout(() => {
        showStatus('图片强制更新完成！', 'success');
      }, 500);
    }

    // 等待DOM完全加载后再初始化
    function initializeApp() {
      console.log('开始初始化应用...');
      
      // 检查DOM元素是否存在
      if (!guideImage) {
        console.error('guideImage 元素未找到');
        return;
      }
      
      if (!countdown) {
        console.error('countdown 元素未找到');
        return;
      }
      
      console.log('DOM元素检查通过，开始初始化...');
      
      // 初始化图片和倒计时
      setImageSource();
      initCountdown();
      
      console.log('应用初始化完成');
    }
    
    // 确保DOM完全加载后再初始化
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }
  </script>
</body>
</html>
