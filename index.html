<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>快捷支付 - 手机端</title>
  <style>
    :root{--bg:#0b0b0b;--btn-height:58px;--accent:#ff6b00}
    html,body{height:100%;margin:0;font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "PingFang SC", "Hiragino Sans GB", "Microsoft Yahei", Arial; background:var(--bg); color:#fff}
    .page{min-height:100vh;display:flex;flex-direction:column}

    /* 顶部信息栏 */
    .header{background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);padding:20px;text-align:center;color:#fff}
    .header-title{font-size:24px;font-weight:bold;margin-bottom:10px}
    .header-info{display:flex;justify-content:space-around;align-items:center;font-size:14px}
    .info-item{display:flex;flex-direction:column;align-items:center}
    .info-label{opacity:0.8;margin-bottom:4px}
    .info-value{font-weight:600}

    /* 图片区域 - 移除边框，全屏显示 */
    .hero{flex:1;display:flex;align-items:center;justify-content:center;padding:0;position:relative;background:#07c160}
    .guide-img{width:100%;height:100%;object-fit:contain;display:block;border-radius:10px}

    /* 倒计时器 - 移到图片上方 */
    .countdown{position:absolute;top:20px;right:20px;background:rgba(255,0,0,0.8);color:#fff;padding:8px 16px;border-radius:20px;font-size:16px;font-weight:600;z-index:100}
    .countdown.expired{background:rgba(255,0,0,0.6);color:#ffcccc}

    /* 扫码支付提示 - 移到图片上方 */
    .hint{position:absolute;left:20px;top:20px;background:rgba(0,0,0,0.7);color:#fff;padding:8px 16px;border-radius:20px;font-size:16px;font-weight:600;z-index:100}
    


    /* 过期提示 */
    .expired-overlay{position:absolute;inset:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:50}
    .expired-overlay.show{display:flex}
    .expired-content{text-align:center;color:#fff}
    .expired-title{font-size:20px;font-weight:600;margin-bottom:12px}
    .expired-desc{font-size:16px;opacity:0.8;margin-bottom:20px}

    /* 底部按钮 */
    .footer{padding:12px;display:flex;gap:12px;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,0.35))}
    .btn{flex:1;max-width:360px;height:var(--btn-height);border-radius:10px;border:0;font-size:18px;font-weight:600;display:inline-flex;align-items:center;justify-content:center;gap:8px}
    .btn.primary{background:var(--accent);color:#fff;box-shadow:0 6px 18px rgba(255,107,0,0.18)}
    .btn.ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.08)}
  </style>
</head>
<body>
  <div class="page">
    <!-- 顶部信息栏 -->
    <header class="header">
      <div class="header-title">快捷支付</div>
      <div class="header-info">
        <div class="info-item">
          <div class="info-label">支付金额</div>
          <div class="info-value" id="paymentAmount">100-2000</div>
        </div>
        <div class="info-item">
          <div class="info-label">有效期</div>
          <div class="info-value" id="validityPeriod">100秒</div>
        </div>
      </div>
    </header>

    <main class="hero">
      <!-- 倒计时器 -->
      <div class="countdown" id="countdown">
        <span id="countdownText">100s</span>
      </div>

      <!-- 扫码支付提示 -->
      <div class="hint" id="scanHint">扫码支付</div>

      <!-- 图片，使用base64数据或后台配置的地址 -->
      <img id="guideImage" class="guide-img" src="" alt="收款引导图" />
      


      <!-- 过期提示覆盖层 -->
      <div class="expired-overlay" id="expiredOverlay">
        <div class="expired-content">
          <div class="expired-title">二维码已过期</div>
          <div class="expired-desc">点击刷新</div>
        </div>
      </div>
    </main>

    <footer class="footer">
      <button id="reloadBtn" class="btn ghost">刷新二维码</button>
      <button id="payBtn" class="btn primary">长按图片识别支付</button>
      
    </footer>
  </div>

  <script>
    // 倒计时配置
    const COUNTDOWN_SECONDS = 100;
    
    // DOM元素
    const guideImage = document.getElementById('guideImage');
    const reloadBtn = document.getElementById('reloadBtn');
    const payBtn = document.getElementById('payBtn');
    const countdown = document.getElementById('countdown');
    const countdownText = document.getElementById('countdownText');
    const expiredOverlay = document.getElementById('expiredOverlay');

    // 动态加载配置文件
    function loadImageConfig() {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = `image-config.js?v=${Date.now()}`;
        script.onload = () => resolve();
        script.onerror = () => reject();
        document.head.appendChild(script);
      });
    }

    // 设置图片源
    function setImageSource() {
      // 优先使用URL参数中的图片地址（用于测试）
      const urlParams = new URLSearchParams(window.location.search);
      let imageUrl = urlParams.get('imageUrl');
      
      if (imageUrl && imageUrl.trim()) {
        imageUrl = decodeURIComponent(imageUrl.trim());
        // 为图片地址添加时间戳防止缓存
        guideImage.src = imageUrl + (imageUrl.includes('?') ? '&' : '?') + 't=' + Date.now();
        return;
      }
      
      // 使用配置文件中的图片地址
      if (window.CURRENT_IMAGE_URL) {
        // 为图片地址添加时间戳防止缓存
        const separator = window.CURRENT_IMAGE_URL.includes('?') ? '&' : '?';
        guideImage.src = window.CURRENT_IMAGE_URL + separator + 't=' + Date.now();
      } else {
        guideImage.src = '/uploads/qrcode.jpg?t=' + Date.now();
      }
    }

    // 倒计时相关变量
    let countdownTimer = null;
    let remainingSeconds = COUNTDOWN_SECONDS;
    let isExpired = false;

    // 初始化倒计时
    function initCountdown() {
      remainingSeconds = COUNTDOWN_SECONDS;
      isExpired = false;
      updateCountdownDisplay();
      startCountdown();
    }

    // 开始倒计时
    function startCountdown() {
      if (countdownTimer) clearInterval(countdownTimer);
      
      countdownTimer = setInterval(() => {
        remainingSeconds--;
        updateCountdownDisplay();
        
        if (remainingSeconds <= 0) {
          clearInterval(countdownTimer);
          handleExpired();
        }
      }, 1000);
    }

    // 更新倒计时显示
    function updateCountdownDisplay() {
      const minutes = Math.floor(remainingSeconds / 60);
      const seconds = remainingSeconds % 60;
      countdownText.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      if (remainingSeconds <= 30) {
        countdown.classList.add('expired');
      } else {
        countdown.classList.remove('expired');
      }
    }

    // 处理过期
    function handleExpired() {
      isExpired = true;
      expiredOverlay.classList.add('show');
      countdown.classList.add('expired');
      countdownText.textContent = '已过期';
      payBtn.disabled = true;
      payBtn.style.opacity = '0.5';
    }

    // 刷新二维码
    function refreshQRCode() {
      // 清除图片缓存
      guideImage.src = '';
      
      // 清除浏览器缓存（如果支持）
      if ('caches' in window) {
        caches.keys().then(function(names) {
          for (let name of names) {
            caches.delete(name);
          }
        });
      }
      
      // 重新加载配置文件（带时间戳防止缓存）
      const script = document.createElement('script');
      script.src = `image-config.js?v=${Date.now()}`;
      script.onload = function() {
        // 配置文件加载完成后，重新设置图片
        setImageSource();
        // 重新初始化倒计时
        initCountdown();
      };
      document.head.appendChild(script);
    }

    // 支付按钮点击事件
    function handlePayClick() {
      if (isExpired) {
        alert('二维码已过期，请刷新二维码');
        return;
      }
      
      alert('请长按图片进行识别支付');
    }

    // 绑定事件
    reloadBtn.addEventListener('click', refreshQRCode);
    payBtn.addEventListener('click', handlePayClick);



    // 初始化
    loadImageConfig().then(() => {
      setImageSource();
      initCountdown();
    }).catch(() => {
      // 如果配置文件加载失败，使用默认图片
      setImageSource();
      initCountdown();
    });
  </script>
</body>
</html>
