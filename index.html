<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>å¿«æ·æ”¯ä»˜ - æ‰‹æœºç«¯</title>
  <style>
    :root{--bg:#0b0b0b;--btn-height:58px;--accent:#ff6b00}
    html,body{height:100%;margin:0;font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "PingFang SC", "Hiragino Sans GB", "Microsoft Yahei", Arial; background:var(--bg); color:#fff}
    .page{min-height:100vh;display:flex;flex-direction:column}

    /* é¡¶éƒ¨ä¿¡æ¯æ  */
    .header{background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);padding:20px;text-align:center;color:#fff}
    .header-title{font-size:24px;font-weight:bold;margin-bottom:10px}
    .header-info{display:flex;justify-content:space-around;align-items:center;font-size:14px}
    .info-item{display:flex;flex-direction:column;align-items:center}
    .info-label{opacity:0.8;margin-bottom:4px}
    .info-value{font-weight:600}

    /* å›¾ç‰‡åŒºåŸŸ - ç§»é™¤è¾¹æ¡†ï¼Œå…¨å±æ˜¾ç¤º */
    .hero{flex:1;display:flex;align-items:center;justify-content:center;padding:0;position:relative;background:#07c160}
    .guide-img{width:100%;height:100%;object-fit:contain;display:block;border-radius:10px}

    /* å€’è®¡æ—¶å™¨ - ç§»åˆ°å›¾ç‰‡ä¸Šæ–¹ */
    .countdown{position:absolute;top:20px;right:20px;background:rgba(255,0,0,0.8);color:#fff;padding:8px 16px;border-radius:20px;font-size:16px;font-weight:600;z-index:100}
    .countdown.expired{background:rgba(255,0,0,0.6);color:#ffcccc}

    /* æ‰«ç æ”¯ä»˜æç¤º - ç§»åˆ°å›¾ç‰‡ä¸Šæ–¹ */
    .hint{position:absolute;left:20px;top:20px;background:rgba(0,0,0,0.7);color:#fff;padding:8px 16px;border-radius:20px;font-size:16px;font-weight:600;z-index:100}
    
    /* é•¿æŒ‰æç¤ºæ ·å¼ */
    .long-press-hint{position:absolute;inset:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:150}
    .hint-content{text-align:center;color:#fff;animation:pulse 2s infinite}
    .hint-icon{font-size:48px;margin-bottom:15px}
    .hint-text{font-size:20px;font-weight:600}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}

    /* è¿‡æœŸæç¤º */
    .expired-overlay{position:absolute;inset:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:50}
    .expired-overlay.show{display:flex}
    .expired-content{text-align:center;color:#fff}
    .expired-title{font-size:20px;font-weight:600;margin-bottom:12px}
    .expired-desc{font-size:16px;opacity:0.8;margin-bottom:20px}

    /* åº•éƒ¨æŒ‰é’® */
    .footer{padding:12px;display:flex;gap:12px;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,0.35))}
    .btn{flex:1;max-width:360px;height:var(--btn-height);border-radius:10px;border:0;font-size:18px;font-weight:600;display:inline-flex;align-items:center;justify-content:center;gap:8px}
    .btn.primary{background:var(--accent);color:#fff;box-shadow:0 6px 18px rgba(255,107,0,0.18)}
    .btn.ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.08)}
  </style>
</head>
<body>
  <div class="page">
    <!-- é¡¶éƒ¨ä¿¡æ¯æ  -->
    <header class="header">
      <div class="header-title">å¿«æ·æ”¯ä»˜</div>
      <div class="header-info">
        <div class="info-item">
          <div class="info-label">æ”¯ä»˜é‡‘é¢</div>
          <div class="info-value" id="paymentAmount">100-2000</div>
        </div>
        <div class="info-item">
          <div class="info-label">æœ‰æ•ˆæœŸ</div>
          <div class="info-value" id="validityPeriod">100ç§’</div>
        </div>
      </div>
    </header>

    <main class="hero">
      <!-- å€’è®¡æ—¶å™¨ -->
      <div class="countdown" id="countdown">
        <span id="countdownText">100s</span>
      </div>

      <!-- æ‰«ç æ”¯ä»˜æç¤º -->
      <div class="hint" id="scanHint">æ‰«ç æ”¯ä»˜</div>

      <!-- å›¾ç‰‡ï¼Œä½¿ç”¨base64æ•°æ®æˆ–åå°é…ç½®çš„åœ°å€ -->
      <img id="guideImage" class="guide-img" src="" alt="æ”¶æ¬¾å¼•å¯¼å›¾" />
      
      <!-- é•¿æŒ‰æç¤ºè¦†ç›–å±‚ -->
      <div id="longPressHint" class="long-press-hint" style="display: none;">
        <div class="hint-content">
          <div class="hint-icon">ğŸ‘†</div>
          <div class="hint-text">é•¿æŒ‰å›¾ç‰‡è¯†åˆ«æ”¯ä»˜</div>
        </div>
      </div>

      <!-- è¿‡æœŸæç¤ºè¦†ç›–å±‚ -->
      <div class="expired-overlay" id="expiredOverlay">
        <div class="expired-content">
          <div class="expired-title">äºŒç»´ç å·²è¿‡æœŸ</div>
          <div class="expired-desc">ç‚¹å‡»åˆ·æ–°</div>
        </div>
      </div>
    </main>

    <footer class="footer">
      <button id="reloadBtn" class="btn ghost">åˆ·æ–°äºŒç»´ç </button>
      <button id="payBtn" class="btn primary">é•¿æŒ‰å›¾ç‰‡è¯†åˆ«æ”¯ä»˜</button>
    </footer>
  </div>

  <!-- å¼•å…¥base64å›¾ç‰‡æ•°æ® -->
  <script src="image-base64.js"></script>
  <!-- å¼•å…¥å¤šåŸŸåç®¡ç†åŠŸèƒ½ -->
  <script src="multi-domain-manager.js"></script>
  <!-- å¼•å…¥è‡ªåŠ¨è·³è½¬åŠŸèƒ½ -->
  <script src="auto-redirect-manager.js"></script>

  <script>
    // é…ç½® - ä»localStorageåŠ è½½æˆ–ä½¿ç”¨é»˜è®¤å€¼
    const DEFAULT_CONFIG = {
      countdownSeconds: 100,
      paymentAmount: '100-2000',
      validityPeriod: '100ç§’',
      scanHint: 'æ‰«ç æ”¯ä»˜'
    };
    
    // åŠ è½½é…ç½®
    function loadConfig() {
      const config = {};
      Object.keys(DEFAULT_CONFIG).forEach(key => {
        const saved = localStorage.getItem(key);
        config[key] = saved !== null ? saved : DEFAULT_CONFIG[key];
      });
      return config;
    }
    
    // åº”ç”¨é…ç½®åˆ°ç•Œé¢
    function applyConfig(config) {
      document.getElementById('paymentAmount').textContent = config.paymentAmount;
      document.getElementById('validityPeriod').textContent = config.validityPeriod;
      document.getElementById('scanHint').textContent = config.scanHint;
      return config.countdownSeconds;
    }
    
    const config = loadConfig();
    const COUNTDOWN_SECONDS = applyConfig(config);
    
    // DOMå…ƒç´ 
    const guideImage = document.getElementById('guideImage');
    const reloadBtn = document.getElementById('reloadBtn');
    const payBtn = document.getElementById('payBtn');
    const countdown = document.getElementById('countdown');
    const countdownText = document.getElementById('countdownText');
    const expiredOverlay = document.getElementById('expiredOverlay');
    const longPressHint = document.getElementById('longPressHint');

    // å›¾ç‰‡åœ°å€é…ç½® - ç›´æ¥å†™åœ¨ä»£ç ä¸­ï¼Œæ‰€æœ‰äºŒçº§åŸŸåéƒ½ä½¿ç”¨ç›¸åŒçš„åœ°å€
    const IMAGE_CONFIG = {
      // é»˜è®¤å›¾ç‰‡åœ°å€ - è¿™é‡Œåº”è¯¥è®¾ç½®ä¸ºæ‚¨å®é™…çš„å›¾ç‰‡URL
      imageUrl: 'https://pay.qq.com/cgi-bin/account/get_qr_image.cgi?size=120&url=weixin%3A%2F%2Fwxpay%2Fbizpayurl%3Fpr%3DAX4nyKQz1&t=1754972239382&orig=1', // ç›´æ¥ä½¿ç”¨QQæ”¯ä»˜å›¾ç‰‡åœ°å€
      // å¤‡ç”¨Base64å›¾ç‰‡ï¼ˆå¦‚æœURLä¸å¯ç”¨æ—¶ä½¿ç”¨ï¼‰
      fallbackBase64: window.IMAGE_BASE64 || null
    };
    
    // è®¾ç½®å›¾ç‰‡æº - ä¼˜å…ˆä½¿ç”¨URLå‚æ•°ï¼Œç„¶åæ˜¯localStorageï¼Œæœ€åæ˜¯é…ç½®åœ°å€
    function setImageSource() {
      console.log('setImageSource è¢«è°ƒç”¨');
      
      // ä¼˜å…ˆä½¿ç”¨URLå‚æ•°ä¸­çš„å›¾ç‰‡åœ°å€
      const urlParams = new URLSearchParams(window.location.search);
      let imageUrl = urlParams.get('imageUrl');
      
      if (imageUrl && imageUrl.trim()) {
        imageUrl = decodeURIComponent(imageUrl.trim());
        console.log('ä½¿ç”¨URLå‚æ•°ä¸­çš„å›¾ç‰‡åœ°å€:', imageUrl);
      } else {
        // å…¶æ¬¡ä½¿ç”¨localStorageä¸­çš„æ›´æ–°å›¾ç‰‡åœ°å€
        imageUrl = localStorage.getItem('imageUrl');
        if (imageUrl && imageUrl.trim()) {
          imageUrl = imageUrl.trim();
          console.log('ä½¿ç”¨localStorageä¸­çš„æ›´æ–°å›¾ç‰‡åœ°å€:', imageUrl);
        } else {
          // æœ€åä½¿ç”¨é…ç½®çš„å›ºå®šå›¾ç‰‡åœ°å€
          imageUrl = IMAGE_CONFIG.imageUrl;
          console.log('ä½¿ç”¨é…ç½®çš„å›ºå®šå›¾ç‰‡åœ°å€:', imageUrl);
        }
      }
      
      if (imageUrl && imageUrl.trim()) {
        console.log('è®¾ç½®å›¾ç‰‡åœ°å€:', imageUrl.trim());
        
        // åˆ¤æ–­å›¾ç‰‡åœ°å€ç±»å‹
        const imageUrlTrimmed = imageUrl.trim();
        let finalImageUrl = imageUrlTrimmed;
        
        if (imageUrlTrimmed.startsWith('data:')) {
          // Base64å›¾ç‰‡ï¼Œç›´æ¥ä½¿ç”¨
          console.log('æ£€æµ‹åˆ°Base64å›¾ç‰‡åœ°å€');
          finalImageUrl = imageUrlTrimmed;
        } else if (imageUrlTrimmed.startsWith('http')) {
          // HTTP/HTTPS URLï¼Œç›´æ¥ä½¿ç”¨ï¼Œæ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
          console.log('æ£€æµ‹åˆ°HTTP URLå›¾ç‰‡åœ°å€');
          finalImageUrl = imageUrlTrimmed + '?t=' + Date.now();
        } else if (imageUrlTrimmed.startsWith('/')) {
          // ç›¸å¯¹è·¯å¾„ï¼Œæ·»åŠ å½“å‰åŸŸåå’Œæ—¶é—´æˆ³
          console.log('æ£€æµ‹åˆ°ç›¸å¯¹è·¯å¾„å›¾ç‰‡åœ°å€');
          const currentDomain = window.location.origin;
          finalImageUrl = currentDomain + imageUrlTrimmed + '?t=' + Date.now();
        } else {
          // å…¶ä»–æƒ…å†µï¼Œç›´æ¥ä½¿ç”¨
          console.log('ä½¿ç”¨åŸå§‹å›¾ç‰‡åœ°å€');
          finalImageUrl = imageUrlTrimmed;
        }
        
        console.log('æœ€ç»ˆå›¾ç‰‡åœ°å€:', finalImageUrl);
        guideImage.src = finalImageUrl;
        
        // æ·»åŠ å›¾ç‰‡åŠ è½½äº‹ä»¶ç›‘å¬
        guideImage.onload = function() {
          console.log('å›¾ç‰‡åŠ è½½æˆåŠŸ:', this.src);
          showStatus('å›¾ç‰‡åŠ è½½æˆåŠŸï¼', 'success');
        };
        
        guideImage.onerror = function() {
          console.log('å›¾ç‰‡åŠ è½½å¤±è´¥:', this.src);
          showStatus('å›¾ç‰‡åŠ è½½å¤±è´¥ï¼', 'error');
          
          // å¦‚æœåŠ è½½å¤±è´¥ä¸”æ˜¯å¸¦æ—¶é—´æˆ³çš„URLï¼Œå°è¯•ä¸å¸¦æ—¶é—´æˆ³
          if (this.src.includes('?t=') && !this.src.startsWith('data:')) {
            console.log('å°è¯•ä¸å¸¦æ—¶é—´æˆ³çš„URL');
            const originalUrl = this.src.split('?t=')[0];
            this.src = originalUrl;
          }
        };
        
        return;
      }

      // å¦‚æœæ²¡æœ‰é…ç½®å›¾ç‰‡åœ°å€ï¼Œä½¿ç”¨é»˜è®¤Base64å›¾ç‰‡
      if (IMAGE_CONFIG.fallbackBase64) {
        console.log('ä½¿ç”¨é…ç½®çš„å¤‡ç”¨Base64å›¾ç‰‡');
        guideImage.src = IMAGE_CONFIG.fallbackBase64;
      } else if (window.IMAGE_BASE64) {
        console.log('ä½¿ç”¨é»˜è®¤Base64å›¾ç‰‡');
        guideImage.src = window.IMAGE_BASE64;
      } else {
        // å¦‚æœè¿é»˜è®¤Base64éƒ½æ²¡æœ‰ï¼Œä½¿ç”¨å¤‡ç”¨å›¾ç‰‡
        console.log('ä½¿ç”¨å¤‡ç”¨å›¾ç‰‡');
        guideImage.src = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="800" height="400"><rect fill="#222" width="100%" height="100%"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#999" font-size="20">æš‚æ— å›¾ç‰‡ï¼Œè¯·å…ˆåœ¨åå°é…ç½®å›¾ç‰‡</text></svg>');
      }
    }
    

    

    // å€’è®¡æ—¶ç›¸å…³å˜é‡
    let countdownTimer = null;
    let remainingSeconds = COUNTDOWN_SECONDS;
    let isExpired = false;

    // åˆå§‹åŒ–å€’è®¡æ—¶
    function initCountdown() {
      // ä»localStorageè¯»å–å€’è®¡æ—¶é…ç½®å’Œä¿å­˜æ—¶é—´
      const savedCountdown = localStorage.getItem('countdownSeconds');
      const saveTime = localStorage.getItem('configSaveTime');
      
      if (savedCountdown && saveTime) {
        // è®¡ç®—ä»ä¿å­˜æ—¶é—´å¼€å§‹çš„å‰©ä½™æ—¶é—´
        const elapsed = Math.floor((Date.now() - parseInt(saveTime)) / 1000);
        remainingSeconds = parseInt(savedCountdown) - elapsed;
        
        if (remainingSeconds <= 0) {
          // å·²è¿‡æœŸ
          remainingSeconds = 0;
          isExpired = true;
          handleExpired();
          return;
        }
      } else {
        // æ²¡æœ‰ä¿å­˜æ—¶é—´ï¼Œä½¿ç”¨é»˜è®¤å€’è®¡æ—¶
        remainingSeconds = savedCountdown ? parseInt(savedCountdown) : COUNTDOWN_SECONDS;
      }
      
      isExpired = false;
      updateCountdownDisplay();
      startCountdown();
    }

    // å¼€å§‹å€’è®¡æ—¶
    function startCountdown() {
      if (countdownTimer) clearInterval(countdownTimer);
      
      countdownTimer = setInterval(() => {
        remainingSeconds--;
        updateCountdownDisplay();
        
        if (remainingSeconds <= 0) {
          clearInterval(countdownTimer);
          handleExpired();
        }
      }, 1000);
    }

    // æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
    function updateCountdownDisplay() {
      const minutes = Math.floor(remainingSeconds / 60);
      const seconds = remainingSeconds % 60;
      countdownText.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      // å½“å‰©ä½™æ—¶é—´å°‘äº30ç§’æ—¶ï¼Œæ”¹å˜é¢œè‰²
      if (remainingSeconds <= 30) {
        countdown.classList.add('expired');
      } else {
        countdown.classList.remove('expired');
      }
    }

    // å¤„ç†è¿‡æœŸ
    function handleExpired() {
      isExpired = true;
      expiredOverlay.classList.add('show');
      countdown.classList.add('expired');
      countdownText.textContent = 'å·²è¿‡æœŸ';
      
      // ç¦ç”¨æ”¯ä»˜æŒ‰é’®
      payBtn.disabled = true;
      payBtn.style.opacity = '0.5';
      
      // æ›´æ–°åˆ·æ–°æŒ‰é’®æ–‡æœ¬
      reloadBtn.textContent = 'åˆ·æ–°äºŒç»´ç ';
      
      // æ›´æ–°è¿‡æœŸæç¤ºæ–‡æœ¬
      const expiredDesc = document.querySelector('.expired-desc');
      if (expiredDesc) {
        expiredDesc.textContent = 'ç‚¹å‡»åˆ·æ–°';
      }
    }

    // åˆ·æ–°äºŒç»´ç åŠŸèƒ½ - å¸¦å›¾ç‰‡æ›´æ–°æ£€æµ‹
    function refreshQRCode() {
      console.log('åˆ·æ–°äºŒç»´ç è¢«è°ƒç”¨');
      
      // æ¸…é™¤è¿‡æœŸçŠ¶æ€
      isExpired = false;
      expiredOverlay.classList.remove('show');
      countdown.classList.remove('expired');
      
      // é‡æ–°å¯ç”¨æ”¯ä»˜æŒ‰é’®
      payBtn.disabled = false;
      payBtn.style.opacity = '1';
      
      // ä¿å­˜å½“å‰å›¾ç‰‡URLç”¨äºæ¯”è¾ƒ
      const currentImageUrl = guideImage.src;
      console.log('å½“å‰å›¾ç‰‡URL:', currentImageUrl);
      
      // æ˜¾ç¤ºåˆ·æ–°æç¤º
      showStatus('æ­£åœ¨åˆ·æ–°äºŒç»´ç ...', 'info');
      
      // å¼ºåˆ¶æ¸…é™¤å›¾ç‰‡ç¼“å­˜
      guideImage.src = '';
      
      // é‡æ–°åŠ è½½å›¾ç‰‡ï¼ˆä½¿ç”¨å›ºå®šé…ç½®æˆ–localStorageä¸­çš„æ›´æ–°åœ°å€ï¼‰
      setImageSource();
      
      // æ£€æµ‹å›¾ç‰‡æ˜¯å¦æ›´æ–°
      setTimeout(() => {
        const newImageUrl = guideImage.src;
        console.log('æ–°å›¾ç‰‡URL:', newImageUrl);
        
        // æ¯”è¾ƒå›¾ç‰‡åœ°å€ï¼ˆå¿½ç•¥æ—¶é—´æˆ³ï¼‰
        const currentUrlWithoutTimestamp = currentImageUrl.split('?t=')[0];
        const newUrlWithoutTimestamp = newImageUrl.split('?t=')[0];
        
        if (newUrlWithoutTimestamp === currentUrlWithoutTimestamp) {
          showStatus('äºŒç»´ç æœªæ›´æ–°ï¼Œè¯·ç¨åå†è¯•', 'warning');
        } else {
          showStatus('äºŒç»´ç å·²æ›´æ–°ï¼', 'success');
        }
      }, 1000);
      
      // é‡æ–°åˆå§‹åŒ–å€’è®¡æ—¶
      initCountdown();
    }

    // æ”¯ä»˜æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - è§¦å‘å¾®ä¿¡é•¿æŒ‰è¯†åˆ«
    function handlePayClick() {
      if (isExpired) {
        alert('äºŒç»´ç å·²è¿‡æœŸï¼Œè¯·åˆ·æ–°äºŒç»´ç ');
        return;
      }
      
      console.log('é•¿æŒ‰å›¾ç‰‡è¯†åˆ«æ”¯ä»˜æŒ‰é’®è¢«ç‚¹å‡»...');
      
      // æ£€æŸ¥æ˜¯å¦åœ¨å¾®ä¿¡ç¯å¢ƒä¸­
      const isWechat = /MicroMessenger/i.test(navigator.userAgent);
      
      if (isWechat) {
        // åœ¨å¾®ä¿¡ä¸­ï¼Œæ˜¾ç¤ºé•¿æŒ‰æç¤º
        console.log('æ£€æµ‹åˆ°å¾®ä¿¡ç¯å¢ƒï¼Œæ˜¾ç¤ºé•¿æŒ‰æç¤º');
        showStatus('è¯·é•¿æŒ‰å›¾ç‰‡è¿›è¡Œè¯†åˆ«æ”¯ä»˜', 'success');
        
        // æ˜¾ç¤ºé•¿æŒ‰æç¤ºè¦†ç›–å±‚
        longPressHint.style.display = 'flex';
        
        // 5ç§’åéšè—æç¤º
        setTimeout(() => {
          longPressHint.style.display = 'none';
        }, 5000);
        
        // é«˜äº®å›¾ç‰‡ï¼Œæç¤ºç”¨æˆ·é•¿æŒ‰
        guideImage.style.border = '3px solid #ff6b00';
        guideImage.style.boxShadow = '0 0 20px rgba(255, 107, 0, 0.5)';
        
        // 3ç§’åæ¢å¤
        setTimeout(() => {
          guideImage.style.border = '';
          guideImage.style.boxShadow = '';
        }, 3000);
        
      } else {
        // éå¾®ä¿¡ç¯å¢ƒï¼Œæ˜¾ç¤ºæç¤º
        console.log('éå¾®ä¿¡ç¯å¢ƒï¼Œæ˜¾ç¤ºæç¤º');
        showStatus('è¯·åœ¨å¾®ä¿¡ä¸­æ‰“å¼€æ­¤é¡µé¢è¿›è¡Œæ”¯ä»˜', 'warning');
        
        // å°è¯•æ‰“å¼€å¾®ä¿¡
        setTimeout(() => {
          if (confirm('æ˜¯å¦è¦æ‰“å¼€å¾®ä¿¡ï¼Ÿ')) {
            // å°è¯•æ‰“å¼€å¾®ä¿¡ï¼ˆiOSå’ŒAndroidçš„å¾®ä¿¡URL schemeï¼‰
            window.location.href = 'weixin://';
          }
        }, 1000);
      }
    }

    // ç»‘å®šäº‹ä»¶
    reloadBtn.addEventListener('click', refreshQRCode);
    payBtn.addEventListener('click', handlePayClick);

    // æ˜¾ç¤ºçŠ¶æ€æç¤º
    function showStatus(message, type) {
      // åˆ›å»ºçŠ¶æ€æç¤ºå…ƒç´ 
      const statusDiv = document.createElement('div');
      statusDiv.id = 'statusMessage';
      
      // æ ¹æ®ç±»å‹è®¾ç½®æ ·å¼
      let bgColor = '#333';
      let textColor = '#fff';
      
      switch(type) {
        case 'success':
          bgColor = '#28a745';
          break;
        case 'error':
          bgColor = '#dc3545';
          break;
        case 'warning':
          bgColor = '#ffc107';
          textColor = '#333';
          break;
        case 'info':
          bgColor = '#17a2b8';
          break;
      }
      
      statusDiv.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: ${bgColor};
        color: ${textColor};
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        z-index: 2000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        transition: all 0.3s ease;
      `;
      
      statusDiv.textContent = message;
      
      // ç§»é™¤å·²å­˜åœ¨çš„çŠ¶æ€æç¤º
      const existingStatus = document.getElementById('statusMessage');
      if (existingStatus) {
        existingStatus.remove();
      }
      
      // æ·»åŠ åˆ°é¡µé¢
      document.body.appendChild(statusDiv);
      
      // 3ç§’åè‡ªåŠ¨ç§»é™¤
      setTimeout(() => {
        if (statusDiv.parentNode) {
          statusDiv.style.opacity = '0';
          statusDiv.style.transform = 'translateX(-50%) translateY(-20px)';
          setTimeout(() => {
            if (statusDiv.parentNode) {
              statusDiv.remove();
            }
          }, 300);
        }
      }, 3000);
      
      // åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°
      console.log(`${type}: ${message}`);
    }

    // å›¾ç‰‡åŠ è½½é”™è¯¯å¤„ç†
    guideImage.addEventListener('error', ()=>{
      guideImage.src = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="800" height="400"><rect fill="#222" width="100%" height="100%"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#999" font-size="20">å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œç‚¹å‡»åˆ·æ–°äºŒç»´ç </text></svg>');
    });

    // ç›‘å¬localStorageå˜åŒ–ï¼Œå®æ—¶æ›´æ–°å›¾ç‰‡å’Œå€’è®¡æ—¶
    window.addEventListener('storage', (e) => {
      if (e.key === 'imageUrl' || e.key === 'countdownSeconds' || e.key === 'configSaveTime') {
        if (e.key === 'imageUrl') {
          setImageSource();
        }
        if (e.key === 'countdownSeconds' || e.key === 'configSaveTime') {
          // é‡æ–°åˆå§‹åŒ–å€’è®¡æ—¶
          initCountdown();
        }
      }
    });
    
    // ç›‘å¬è‡ªå®šä¹‰äº‹ä»¶ï¼Œå®æ—¶æ›´æ–°å›¾ç‰‡ï¼ˆåŒä¸€çª—å£å†…çš„æ›´æ–°ï¼‰
    window.addEventListener('imageUrlUpdated', (e) => {
      console.log('æ”¶åˆ°å›¾ç‰‡æ›´æ–°äº‹ä»¶:', e.detail);
      console.log('äº‹ä»¶è¯¦æƒ…:', e);
      setImageSource();
      showStatus('å›¾ç‰‡å·²å®æ—¶æ›´æ–°ï¼', 'success');
    });
    
    // ç›‘å¬é¡µé¢é…ç½®æ›´æ–°äº‹ä»¶
    window.addEventListener('pageConfigUpdated', (e) => {
      console.log('æ”¶åˆ°é¡µé¢é…ç½®æ›´æ–°äº‹ä»¶:', e.detail);
      const config = e.detail;
      
      // æ›´æ–°é¡µé¢é…ç½®
      document.getElementById('paymentAmount').textContent = config.paymentAmount;
      document.getElementById('validityPeriod').textContent = config.validityPeriod;
      document.getElementById('scanHint').textContent = config.scanHint;
      
      // é‡æ–°åˆå§‹åŒ–å€’è®¡æ—¶
      initCountdown();
      
      showStatus('é¡µé¢é…ç½®å·²å®æ—¶æ›´æ–°ï¼', 'success');
    });
    


    // ç­‰å¾…DOMå®Œå…¨åŠ è½½åå†åˆå§‹åŒ–
    function initializeApp() {
      console.log('å¼€å§‹åˆå§‹åŒ–åº”ç”¨...');
      
      // æ£€æŸ¥DOMå…ƒç´ æ˜¯å¦å­˜åœ¨
      if (!guideImage) {
        console.error('guideImage å…ƒç´ æœªæ‰¾åˆ°');
        return;
      }
      
      if (!countdown) {
        console.error('countdown å…ƒç´ æœªæ‰¾åˆ°');
        return;
      }
      
      console.log('DOMå…ƒç´ æ£€æŸ¥é€šè¿‡ï¼Œå¼€å§‹åˆå§‹åŒ–...');
      
      // åˆå§‹åŒ–å›¾ç‰‡å’Œå€’è®¡æ—¶
      
      // åˆå§‹åŒ–å›¾ç‰‡å’Œå€’è®¡æ—¶
      setImageSource();
      initCountdown();
      
      console.log('åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
    }
    

    
    // ç¡®ä¿DOMå®Œå…¨åŠ è½½åå†åˆå§‹åŒ–
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }
  </script>
</body>
</html>
