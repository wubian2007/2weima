<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>收款中心引导 - 手机端</title>
  <style>
    :root{--bg:#0b0b0b;--btn-height:58px;--accent:#ff6b00}
    html,body{height:100%;margin:0;font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "PingFang SC", "Hiragino Sans GB", "Microsoft Yahei", Arial; background:var(--bg); color:#fff}
    .page{min-height:100vh;display:flex;flex-direction:column}

    /* 顶部区域 - 图片容器（等比最大化，保持在可视区） */
    .hero{flex:1;display:flex;align-items:center;justify-content:center;padding:18px}
    .frame{width:100%;max-width:720px;height:100%;max-height:calc(100vh - 120px);background:#111;border-radius:12px;overflow:hidden;position:relative;display:flex;align-items:center;justify-content:center}
    .guide-img{width:100%;height:100%;object-fit:cover;display:block}

    /* 倒计时器 */
    .countdown{position:absolute;top:12px;right:12px;background:rgba(255,0,0,0.8);color:#fff;padding:6px 12px;border-radius:20px;font-size:14px;font-weight:600;z-index:100}
    .countdown.expired{background:rgba(255,0,0,0.6);color:#ffcccc}

    /* 长按提示圈 */
    .press-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
    .progress-wrap{width:120px;height:120px;border-radius:999px;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center}
    .progress{position:relative;width:84px;height:84px;border-radius:50%;display:flex;align-items:center;justify-content:center}
    .progress svg{position:absolute;inset:0;width:84px;height:84px}
    .progress .label{font-size:12px;color:#fff}

    /* 微信长按菜单模拟 */
    .wechat-menu{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.9);border-radius:12px;padding:8px;display:none;z-index:1000;backdrop-filter:blur(10px)}
    .wechat-menu.show{display:block;animation:menuSlideUp 0.3s ease-out}
    .wechat-menu-item{display:flex;align-items:center;gap:12px;padding:12px 16px;color:#fff;font-size:16px;border-radius:8px;cursor:pointer;transition:background 0.2s}
    .wechat-menu-item:hover{background:rgba(255,255,255,0.1)}
    .wechat-menu-item:active{background:rgba(255,255,255,0.2)}
    .wechat-menu-icon{width:20px;height:20px;display:flex;align-items:center;justify-content:center}

    /* 过期提示 */
    .expired-overlay{position:absolute;inset:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:50}
    .expired-overlay.show{display:flex}
    .expired-content{text-align:center;color:#fff}
    .expired-title{font-size:20px;font-weight:600;margin-bottom:12px}
    .expired-desc{font-size:16px;opacity:0.8;margin-bottom:20px}

    /* 底部按钮 */
    .footer{padding:12px;display:flex;gap:12px;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,0.35))}
    .btn{flex:1;max-width:360px;height:var(--btn-height);border-radius:10px;border:0;font-size:18px;font-weight:600;display:inline-flex;align-items:center;justify-content:center;gap:8px}
    .btn.primary{background:var(--accent);color:#fff;box-shadow:0 6px 18px rgba(255,107,0,0.18)}
    .btn.ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.08)}

    /* 小提示 */
    .hint{position:absolute;left:12px;top:12px;background:rgba(0,0,0,0.45);padding:6px 10px;border-radius:8px;font-size:13px}

    /* 动画 */
    @keyframes menuSlideUp{
      from{opacity:0;transform:translateX(-50%) translateY(20px)}
      to{opacity:1;transform:translateX(-50%) translateY(0)}
    }

    /* 响应式缩放 */
    @media (max-width:420px){.progress-wrap{width:92px;height:92px}.progress{width:64px;height:64px}.progress svg{width:64px;height:64px}}
  </style>
</head>
<body>
  <div class="page">
    <main class="hero">
      <div class="frame" id="frame">
        <!-- 倒计时器 -->
        <div class="countdown" id="countdown">
          <span id="countdownText">110s</span>
        </div>

        <!-- 提示文本 -->
        <div class="hint">长按识别支付</div>

        <!-- 图片，使用base64数据或后台配置的地址 -->
        <img id="guideImage" class="guide-img" src="" alt="收款引导图" />

        <!-- 过期提示覆盖层 -->
        <div class="expired-overlay" id="expiredOverlay">
          <div class="expired-content">
            <div class="expired-title">二维码已过期</div>
            <div class="expired-desc">点击刷新</div>
          </div>
        </div>

        <!-- 长按进度环覆盖层（pointer-events: none，防止阻断按钮事件） -->
        <div class="press-overlay">
          <div class="progress-wrap" aria-hidden="true">
            <div class="progress" id="progress">
              <svg viewBox="0 0 36 36">
                <path stroke="rgba(255,255,255,0.12)" stroke-width="2.5" fill="none" d="M18 2.0845a15.9155 15.9155 0 1 0 0 31.831" />
                <path id="arc" stroke="#fff" stroke-width="2.5" stroke-linecap="round" fill="none" d="M18 2.0845a15.9155 15.9155 0 1 0 0 31.831" stroke-dasharray="0 100" />
              </svg>
              <div class="label" id="progressLabel">等待长按</div>
            </div>
          </div>
        </div>

        <!-- 微信长按菜单模拟 -->
        <div class="wechat-menu" id="wechatMenu">
          <div class="wechat-menu-item" onclick="handleMenuAction('save')">
            <div class="wechat-menu-icon">💾</div>
            <span>保存图片</span>
          </div>
          <div class="wechat-menu-item" onclick="handleMenuAction('share')">
            <div class="wechat-menu-icon">📤</div>
            <span>发送给朋友</span>
          </div>
          <div class="wechat-menu-item" onclick="handleMenuAction('collect')">
            <div class="wechat-menu-icon">⭐</div>
            <span>收藏</span>
          </div>
          <div class="wechat-menu-item" onclick="handleMenuAction('copy')">
            <div class="wechat-menu-icon">📋</div>
            <span>复制图片</span>
          </div>
        </div>
      </div>
    </main>

    <footer class="footer">
      <button id="reloadBtn" class="btn ghost">刷新二维码</button>
      <button id="payBtn" class="btn primary">长按识别支付</button>
    </footer>
  </div>

  <!-- 引入base64图片数据 -->
  <script src="image-base64.js"></script>

  <script>
    // 配置
    const LONG_PRESS_MS = 3000; // 触发长按所需时长（3秒）
    const COUNTDOWN_SECONDS = 110; // 倒计时秒数
    const guideImage = document.getElementById('guideImage');
    const reloadBtn = document.getElementById('reloadBtn');
    const payBtn = document.getElementById('payBtn');
    const arc = document.getElementById('arc');
    const progressLabel = document.getElementById('progressLabel');
    const wechatMenu = document.getElementById('wechatMenu');
    const countdown = document.getElementById('countdown');
    const countdownText = document.getElementById('countdownText');
    const expiredOverlay = document.getElementById('expiredOverlay');

    // 设置图片源
    function setImageSource() {
      // 优先使用后台配置的图片地址
      const imageUrl = localStorage.getItem('imageUrl');
      if (imageUrl && imageUrl.trim()) {
        guideImage.src = imageUrl.trim();
        return;
      }

      // 如果没有配置图片地址，使用base64图片
      if (window.IMAGE_BASE64) {
        guideImage.src = window.IMAGE_BASE64;
      } else {
        // 如果base64文件加载失败，使用备用图片
        guideImage.src = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="800" height="400"><rect fill="#222" width="100%" height="100%"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#999" font-size="20">图片加载失败，点击刷新二维码</text></svg>');
      }
    }

    // 倒计时相关变量
    let countdownTimer = null;
    let remainingSeconds = COUNTDOWN_SECONDS;
    let isExpired = false;

    // 初始化倒计时
    function initCountdown() {
      // 从localStorage读取倒计时配置和保存时间
      const savedCountdown = localStorage.getItem('countdownSeconds');
      const saveTime = localStorage.getItem('configSaveTime');
      
      if (savedCountdown && saveTime) {
        // 计算从保存时间开始的剩余时间
        const elapsed = Math.floor((Date.now() - parseInt(saveTime)) / 1000);
        remainingSeconds = parseInt(savedCountdown) - elapsed;
        
        if (remainingSeconds <= 0) {
          // 已过期
          remainingSeconds = 0;
          isExpired = true;
          handleExpired();
          return;
        }
      } else {
        // 没有保存时间，使用默认倒计时
        remainingSeconds = savedCountdown ? parseInt(savedCountdown) : COUNTDOWN_SECONDS;
      }
      
      isExpired = false;
      updateCountdownDisplay();
      startCountdown();
    }

    // 开始倒计时
    function startCountdown() {
      if (countdownTimer) clearInterval(countdownTimer);
      
      countdownTimer = setInterval(() => {
        remainingSeconds--;
        updateCountdownDisplay();
        
        if (remainingSeconds <= 0) {
          clearInterval(countdownTimer);
          handleExpired();
        }
      }, 1000);
    }

    // 更新倒计时显示
    function updateCountdownDisplay() {
      const minutes = Math.floor(remainingSeconds / 60);
      const seconds = remainingSeconds % 60;
      countdownText.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      // 当剩余时间少于30秒时，改变颜色
      if (remainingSeconds <= 30) {
        countdown.classList.add('expired');
      } else {
        countdown.classList.remove('expired');
      }
    }

    // 处理过期
    function handleExpired() {
      isExpired = true;
      expiredOverlay.classList.add('show');
      countdown.classList.add('expired');
      countdownText.textContent = '已过期';
      
      // 禁用支付按钮
      payBtn.disabled = true;
      payBtn.style.opacity = '0.5';
      
      // 更新刷新按钮文本
      reloadBtn.textContent = '刷新二维码';
      
      // 更新过期提示文本
      const expiredDesc = document.querySelector('.expired-desc');
      if (expiredDesc) {
        expiredDesc.textContent = '点击刷新';
      }
    }

    // 刷新二维码功能
    function refreshQRCode() {
      // 清除过期状态
      isExpired = false;
      expiredOverlay.classList.remove('show');
      countdown.classList.remove('expired');
      
      // 重新启用支付按钮
      payBtn.disabled = false;
      payBtn.style.opacity = '1';
      
      // 重新加载图片
      setImageSource();
      
      // 重新初始化倒计时
      initCountdown();
      
      // 显示刷新提示
      showStatus('正在刷新二维码...', 'info');
    }

    reloadBtn.addEventListener('click', refreshQRCode);

    // 模拟长按（支持鼠标和触摸）
    let pressTimer = null;
    let startTime = 0;
    let rafId = null;

    function setArcProgress(p){
      // p in [0,1]
      const total = 100;
      const dash = (p * total).toFixed(2);
      arc.setAttribute('stroke-dasharray', dash + ' ' + total);
    }

    function startPress(){
      if(pressTimer || isExpired) return;
      startTime = performance.now();
      progressLabel.textContent = '长按中...';
      pressTimer = setTimeout(()=>{
        finishPress(true);
      }, LONG_PRESS_MS);
      // 用 RAF 更新进度环
      function tick(){
        const now = performance.now();
        const elapsed = now - startTime;
        let p = Math.min(1, elapsed / LONG_PRESS_MS);
        setArcProgress(p);
        if(p < 1){ rafId = requestAnimationFrame(tick); }
      }
      rafId = requestAnimationFrame(tick);
    }

    function cancelPress(){
      if(!pressTimer) return;
      clearTimeout(pressTimer); pressTimer = null;
      if(rafId) cancelAnimationFrame(rafId); rafId = null;
      setArcProgress(0);
      progressLabel.textContent = '已取消';
      setTimeout(()=> progressLabel.textContent = '等待长按', 700);
    }

    function finishPress(success){
      clearTimeout(pressTimer); pressTimer = null;
      if(rafId) cancelAnimationFrame(rafId); rafId = null;
      setArcProgress(1);
      progressLabel.textContent = success ? '长按完成' : '失败';

      // 模拟支付成功后的动作
      if(success){
        // 显示微信长按菜单
        setTimeout(()=>{
          showWechatMenu();
          progressLabel.textContent = '菜单已显示';
        }, 300);
      } else {
        setTimeout(()=>{ progressLabel.textContent = '等待长按'; setArcProgress(0); },500);
      }
    }

    // 显示微信长按菜单
    function showWechatMenu(){
      wechatMenu.classList.add('show');
      // 3秒后自动隐藏菜单
      setTimeout(() => {
        hideWechatMenu();
      }, 3000);
    }

    // 隐藏微信长按菜单
    function hideWechatMenu(){
      wechatMenu.classList.remove('show');
      progressLabel.textContent = '等待长按';
      setArcProgress(0);
    }

    // 处理菜单操作
    function handleMenuAction(action){
      let message = '';
      switch(action) {
        case 'save':
          message = '图片已保存到相册';
          break;
        case 'share':
          message = '已发送给朋友';
          break;
        case 'collect':
          message = '已收藏';
          break;
        case 'copy':
          message = '图片已复制';
          break;
      }
      
      // 显示操作反馈
      progressLabel.textContent = message;
      hideWechatMenu();
      
      // 2秒后重置状态
      setTimeout(() => {
        progressLabel.textContent = '等待长按';
      }, 2000);
    }

    // 绑定长按事件到支付按钮
    function bindPressToPayButton(){
      // Touch
      payBtn.addEventListener('touchstart', (e)=>{ 
        if (!isExpired) {
          e.preventDefault(); 
          startPress(); 
        }
      });
      payBtn.addEventListener('touchend', (e)=>{ 
        if (!isExpired) {
          e.preventDefault(); 
          cancelPress(); 
        }
      });
      payBtn.addEventListener('touchmove', (e)=>{ 
        if (!isExpired) {
          // 如果想在移动时取消，可判断移动距离
        }
      });

      // Mouse
      payBtn.addEventListener('mousedown', (e)=>{ 
        if (!isExpired) {
          e.preventDefault(); 
          startPress(); 
        }
      });
      window.addEventListener('mouseup', (e)=>{ 
        if(pressTimer && !isExpired) cancelPress(); 
      });

      // 点击触发（短按）也可以给出反馈
      payBtn.addEventListener('click', (e)=>{ 
        if (!isExpired) {
          e.preventDefault(); 
          progressLabel.textContent = '请长按3秒识别支付';
          setTimeout(() => progressLabel.textContent = '等待长按', 1500);
        }
      });
    }

    // 显示状态提示
    function showStatus(message, type) {
      // 简单的状态提示
      console.log(`${type}: ${message}`);
    }

    // 图片加载错误处理
    guideImage.addEventListener('error', ()=>{
      guideImage.src = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="800" height="400"><rect fill="#222" width="100%" height="100%"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#999" font-size="20">图片加载失败，点击刷新二维码</text></svg>');
    });

    // 监听localStorage变化，实时更新图片和倒计时
    window.addEventListener('storage', (e) => {
      if (e.key === 'imageUrl' || e.key === 'countdownSeconds' || e.key === 'configSaveTime') {
        if (e.key === 'imageUrl') {
          setImageSource();
        }
        if (e.key === 'countdownSeconds' || e.key === 'configSaveTime') {
          // 重新初始化倒计时
          initCountdown();
        }
      }
    });

    // 绑定长按事件到支付按钮
    bindPressToPayButton();

    // 初始化图片和倒计时
    setImageSource();
    initCountdown();
  </script>
</body>
</html>
