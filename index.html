<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>æ”¶æ¬¾ä¸­å¿ƒå¼•å¯¼ - æ‰‹æœºç«¯</title>
  <style>
    :root{--bg:#0b0b0b;--btn-height:58px;--accent:#ff6b00}
    html,body{height:100%;margin:0;font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "PingFang SC", "Hiragino Sans GB", "Microsoft Yahei", Arial; background:var(--bg); color:#fff}
    .page{min-height:100vh;display:flex;flex-direction:column}

    /* é¡¶éƒ¨åŒºåŸŸ - å›¾ç‰‡å®¹å™¨ï¼ˆç­‰æ¯”æœ€å¤§åŒ–ï¼Œä¿æŒåœ¨å¯è§†åŒºï¼‰ */
    .hero{flex:1;display:flex;align-items:center;justify-content:center;padding:18px}
    .frame{width:100%;max-width:720px;height:100%;max-height:calc(100vh - 120px);background:#111;border-radius:12px;overflow:hidden;position:relative;display:flex;align-items:center;justify-content:center}
    .guide-img{width:100%;height:100%;object-fit:cover;display:block}

    /* å€’è®¡æ—¶å™¨ */
    .countdown{position:absolute;top:12px;right:12px;background:rgba(255,0,0,0.8);color:#fff;padding:6px 12px;border-radius:20px;font-size:14px;font-weight:600;z-index:100}
    .countdown.expired{background:rgba(255,0,0,0.6);color:#ffcccc}

    /* é•¿æŒ‰æç¤ºåœˆ */
    .press-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
    .progress-wrap{width:120px;height:120px;border-radius:999px;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center}
    .progress{position:relative;width:84px;height:84px;border-radius:50%;display:flex;align-items:center;justify-content:center}
    .progress svg{position:absolute;inset:0;width:84px;height:84px}
    .progress .label{font-size:12px;color:#fff}

    /* å¾®ä¿¡é•¿æŒ‰èœå•æ¨¡æ‹Ÿ */
    .wechat-menu{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.9);border-radius:12px;padding:8px;display:none;z-index:1000;backdrop-filter:blur(10px)}
    .wechat-menu.show{display:block;animation:menuSlideUp 0.3s ease-out}
    .wechat-menu-item{display:flex;align-items:center;gap:12px;padding:12px 16px;color:#fff;font-size:16px;border-radius:8px;cursor:pointer;transition:background 0.2s}
    .wechat-menu-item:hover{background:rgba(255,255,255,0.1)}
    .wechat-menu-item:active{background:rgba(255,255,255,0.2)}
    .wechat-menu-icon{width:20px;height:20px;display:flex;align-items:center;justify-content:center}

    /* è¿‡æœŸæç¤º */
    .expired-overlay{position:absolute;inset:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:50}
    .expired-overlay.show{display:flex}
    .expired-content{text-align:center;color:#fff}
    .expired-title{font-size:20px;font-weight:600;margin-bottom:12px}
    .expired-desc{font-size:16px;opacity:0.8;margin-bottom:20px}

    /* åº•éƒ¨æŒ‰é’® */
    .footer{padding:12px;display:flex;gap:12px;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,0.35))}
    .btn{flex:1;max-width:360px;height:var(--btn-height);border-radius:10px;border:0;font-size:18px;font-weight:600;display:inline-flex;align-items:center;justify-content:center;gap:8px}
    .btn.primary{background:var(--accent);color:#fff;box-shadow:0 6px 18px rgba(255,107,0,0.18)}
    .btn.ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.08)}

    /* å°æç¤º */
    .hint{position:absolute;left:12px;top:12px;background:rgba(0,0,0,0.45);padding:6px 10px;border-radius:8px;font-size:13px}

    /* åŠ¨ç”» */
    @keyframes menuSlideUp{
      from{opacity:0;transform:translateX(-50%) translateY(20px)}
      to{opacity:1;transform:translateX(-50%) translateY(0)}
    }

    /* å“åº”å¼ç¼©æ”¾ */
    @media (max-width:420px){.progress-wrap{width:92px;height:92px}.progress{width:64px;height:64px}.progress svg{width:64px;height:64px}}
  </style>
</head>
<body>
  <div class="page">
    <main class="hero">
      <div class="frame" id="frame">
        <!-- å€’è®¡æ—¶å™¨ -->
        <div class="countdown" id="countdown">
          <span id="countdownText">110s</span>
        </div>

        <!-- æç¤ºæ–‡æœ¬ -->
        <div class="hint">é•¿æŒ‰è¯†åˆ«æ”¯ä»˜</div>

        <!-- å›¾ç‰‡ï¼Œä½¿ç”¨base64æ•°æ®æˆ–åå°é…ç½®çš„åœ°å€ -->
        <img id="guideImage" class="guide-img" src="" alt="æ”¶æ¬¾å¼•å¯¼å›¾" />

        <!-- è¿‡æœŸæç¤ºè¦†ç›–å±‚ -->
        <div class="expired-overlay" id="expiredOverlay">
          <div class="expired-content">
            <div class="expired-title">äºŒç»´ç å·²è¿‡æœŸ</div>
            <div class="expired-desc">ç‚¹å‡»åˆ·æ–°</div>
          </div>
        </div>

        <!-- é•¿æŒ‰è¿›åº¦ç¯è¦†ç›–å±‚ï¼ˆpointer-events: noneï¼Œé˜²æ­¢é˜»æ–­æŒ‰é’®äº‹ä»¶ï¼‰ -->
        <div class="press-overlay">
          <div class="progress-wrap" aria-hidden="true">
            <div class="progress" id="progress">
              <svg viewBox="0 0 36 36">
                <path stroke="rgba(255,255,255,0.12)" stroke-width="2.5" fill="none" d="M18 2.0845a15.9155 15.9155 0 1 0 0 31.831" />
                <path id="arc" stroke="#fff" stroke-width="2.5" stroke-linecap="round" fill="none" d="M18 2.0845a15.9155 15.9155 0 1 0 0 31.831" stroke-dasharray="0 100" />
              </svg>
              <div class="label" id="progressLabel">ç­‰å¾…é•¿æŒ‰</div>
            </div>
          </div>
        </div>

        <!-- å¾®ä¿¡é•¿æŒ‰èœå•æ¨¡æ‹Ÿ -->
        <div class="wechat-menu" id="wechatMenu">
          <div class="wechat-menu-item" onclick="handleMenuAction('save')">
            <div class="wechat-menu-icon">ğŸ’¾</div>
            <span>ä¿å­˜å›¾ç‰‡</span>
          </div>
          <div class="wechat-menu-item" onclick="handleMenuAction('share')">
            <div class="wechat-menu-icon">ğŸ“¤</div>
            <span>å‘é€ç»™æœ‹å‹</span>
          </div>
          <div class="wechat-menu-item" onclick="handleMenuAction('collect')">
            <div class="wechat-menu-icon">â­</div>
            <span>æ”¶è—</span>
          </div>
          <div class="wechat-menu-item" onclick="handleMenuAction('copy')">
            <div class="wechat-menu-icon">ğŸ“‹</div>
            <span>å¤åˆ¶å›¾ç‰‡</span>
          </div>
        </div>
      </div>
    </main>

    <footer class="footer">
      <button id="reloadBtn" class="btn ghost">åˆ·æ–°äºŒç»´ç </button>
      <button id="payBtn" class="btn primary">é•¿æŒ‰è¯†åˆ«æ”¯ä»˜</button>
    </footer>
  </div>

  <!-- å¼•å…¥base64å›¾ç‰‡æ•°æ® -->
  <script src="image-base64.js"></script>

  <script>
    // é…ç½®
    const LONG_PRESS_MS = 3000; // è§¦å‘é•¿æŒ‰æ‰€éœ€æ—¶é•¿ï¼ˆ3ç§’ï¼‰
    const COUNTDOWN_SECONDS = 110; // å€’è®¡æ—¶ç§’æ•°
    const guideImage = document.getElementById('guideImage');
    const reloadBtn = document.getElementById('reloadBtn');
    const payBtn = document.getElementById('payBtn');
    const arc = document.getElementById('arc');
    const progressLabel = document.getElementById('progressLabel');
    const wechatMenu = document.getElementById('wechatMenu');
    const countdown = document.getElementById('countdown');
    const countdownText = document.getElementById('countdownText');
    const expiredOverlay = document.getElementById('expiredOverlay');

    // è®¾ç½®å›¾ç‰‡æº
    function setImageSource() {
      // ä¼˜å…ˆä½¿ç”¨åå°é…ç½®çš„å›¾ç‰‡åœ°å€
      const imageUrl = localStorage.getItem('imageUrl');
      if (imageUrl && imageUrl.trim()) {
        guideImage.src = imageUrl.trim();
        return;
      }

      // å¦‚æœæ²¡æœ‰é…ç½®å›¾ç‰‡åœ°å€ï¼Œä½¿ç”¨base64å›¾ç‰‡
      if (window.IMAGE_BASE64) {
        guideImage.src = window.IMAGE_BASE64;
      } else {
        // å¦‚æœbase64æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨å›¾ç‰‡
        guideImage.src = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="800" height="400"><rect fill="#222" width="100%" height="100%"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#999" font-size="20">å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œç‚¹å‡»åˆ·æ–°äºŒç»´ç </text></svg>');
      }
    }

    // å€’è®¡æ—¶ç›¸å…³å˜é‡
    let countdownTimer = null;
    let remainingSeconds = COUNTDOWN_SECONDS;
    let isExpired = false;

    // åˆå§‹åŒ–å€’è®¡æ—¶
    function initCountdown() {
      // ä»localStorageè¯»å–å€’è®¡æ—¶é…ç½®å’Œä¿å­˜æ—¶é—´
      const savedCountdown = localStorage.getItem('countdownSeconds');
      const saveTime = localStorage.getItem('configSaveTime');
      
      if (savedCountdown && saveTime) {
        // è®¡ç®—ä»ä¿å­˜æ—¶é—´å¼€å§‹çš„å‰©ä½™æ—¶é—´
        const elapsed = Math.floor((Date.now() - parseInt(saveTime)) / 1000);
        remainingSeconds = parseInt(savedCountdown) - elapsed;
        
        if (remainingSeconds <= 0) {
          // å·²è¿‡æœŸ
          remainingSeconds = 0;
          isExpired = true;
          handleExpired();
          return;
        }
      } else {
        // æ²¡æœ‰ä¿å­˜æ—¶é—´ï¼Œä½¿ç”¨é»˜è®¤å€’è®¡æ—¶
        remainingSeconds = savedCountdown ? parseInt(savedCountdown) : COUNTDOWN_SECONDS;
      }
      
      isExpired = false;
      updateCountdownDisplay();
      startCountdown();
    }

    // å¼€å§‹å€’è®¡æ—¶
    function startCountdown() {
      if (countdownTimer) clearInterval(countdownTimer);
      
      countdownTimer = setInterval(() => {
        remainingSeconds--;
        updateCountdownDisplay();
        
        if (remainingSeconds <= 0) {
          clearInterval(countdownTimer);
          handleExpired();
        }
      }, 1000);
    }

    // æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
    function updateCountdownDisplay() {
      const minutes = Math.floor(remainingSeconds / 60);
      const seconds = remainingSeconds % 60;
      countdownText.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      // å½“å‰©ä½™æ—¶é—´å°‘äº30ç§’æ—¶ï¼Œæ”¹å˜é¢œè‰²
      if (remainingSeconds <= 30) {
        countdown.classList.add('expired');
      } else {
        countdown.classList.remove('expired');
      }
    }

    // å¤„ç†è¿‡æœŸ
    function handleExpired() {
      isExpired = true;
      expiredOverlay.classList.add('show');
      countdown.classList.add('expired');
      countdownText.textContent = 'å·²è¿‡æœŸ';
      
      // ç¦ç”¨æ”¯ä»˜æŒ‰é’®
      payBtn.disabled = true;
      payBtn.style.opacity = '0.5';
      
      // æ›´æ–°åˆ·æ–°æŒ‰é’®æ–‡æœ¬
      reloadBtn.textContent = 'åˆ·æ–°äºŒç»´ç ';
      
      // æ›´æ–°è¿‡æœŸæç¤ºæ–‡æœ¬
      const expiredDesc = document.querySelector('.expired-desc');
      if (expiredDesc) {
        expiredDesc.textContent = 'ç‚¹å‡»åˆ·æ–°';
      }
    }

    // åˆ·æ–°äºŒç»´ç åŠŸèƒ½
    function refreshQRCode() {
      // æ¸…é™¤è¿‡æœŸçŠ¶æ€
      isExpired = false;
      expiredOverlay.classList.remove('show');
      countdown.classList.remove('expired');
      
      // é‡æ–°å¯ç”¨æ”¯ä»˜æŒ‰é’®
      payBtn.disabled = false;
      payBtn.style.opacity = '1';
      
      // é‡æ–°åŠ è½½å›¾ç‰‡
      setImageSource();
      
      // é‡æ–°åˆå§‹åŒ–å€’è®¡æ—¶
      initCountdown();
      
      // æ˜¾ç¤ºåˆ·æ–°æç¤º
      showStatus('æ­£åœ¨åˆ·æ–°äºŒç»´ç ...', 'info');
    }

    reloadBtn.addEventListener('click', refreshQRCode);

    // æ¨¡æ‹Ÿé•¿æŒ‰ï¼ˆæ”¯æŒé¼ æ ‡å’Œè§¦æ‘¸ï¼‰
    let pressTimer = null;
    let startTime = 0;
    let rafId = null;

    function setArcProgress(p){
      // p in [0,1]
      const total = 100;
      const dash = (p * total).toFixed(2);
      arc.setAttribute('stroke-dasharray', dash + ' ' + total);
    }

    function startPress(){
      if(pressTimer || isExpired) return;
      startTime = performance.now();
      progressLabel.textContent = 'é•¿æŒ‰ä¸­...';
      pressTimer = setTimeout(()=>{
        finishPress(true);
      }, LONG_PRESS_MS);
      // ç”¨ RAF æ›´æ–°è¿›åº¦ç¯
      function tick(){
        const now = performance.now();
        const elapsed = now - startTime;
        let p = Math.min(1, elapsed / LONG_PRESS_MS);
        setArcProgress(p);
        if(p < 1){ rafId = requestAnimationFrame(tick); }
      }
      rafId = requestAnimationFrame(tick);
    }

    function cancelPress(){
      if(!pressTimer) return;
      clearTimeout(pressTimer); pressTimer = null;
      if(rafId) cancelAnimationFrame(rafId); rafId = null;
      setArcProgress(0);
      progressLabel.textContent = 'å·²å–æ¶ˆ';
      setTimeout(()=> progressLabel.textContent = 'ç­‰å¾…é•¿æŒ‰', 700);
    }

    function finishPress(success){
      clearTimeout(pressTimer); pressTimer = null;
      if(rafId) cancelAnimationFrame(rafId); rafId = null;
      setArcProgress(1);
      progressLabel.textContent = success ? 'é•¿æŒ‰å®Œæˆ' : 'å¤±è´¥';

      // æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸåçš„åŠ¨ä½œ
      if(success){
        // æ˜¾ç¤ºå¾®ä¿¡é•¿æŒ‰èœå•
        setTimeout(()=>{
          showWechatMenu();
          progressLabel.textContent = 'èœå•å·²æ˜¾ç¤º';
        }, 300);
      } else {
        setTimeout(()=>{ progressLabel.textContent = 'ç­‰å¾…é•¿æŒ‰'; setArcProgress(0); },500);
      }
    }

    // æ˜¾ç¤ºå¾®ä¿¡é•¿æŒ‰èœå•
    function showWechatMenu(){
      wechatMenu.classList.add('show');
      // 3ç§’åè‡ªåŠ¨éšè—èœå•
      setTimeout(() => {
        hideWechatMenu();
      }, 3000);
    }

    // éšè—å¾®ä¿¡é•¿æŒ‰èœå•
    function hideWechatMenu(){
      wechatMenu.classList.remove('show');
      progressLabel.textContent = 'ç­‰å¾…é•¿æŒ‰';
      setArcProgress(0);
    }

    // å¤„ç†èœå•æ“ä½œ
    function handleMenuAction(action){
      let message = '';
      switch(action) {
        case 'save':
          message = 'å›¾ç‰‡å·²ä¿å­˜åˆ°ç›¸å†Œ';
          break;
        case 'share':
          message = 'å·²å‘é€ç»™æœ‹å‹';
          break;
        case 'collect':
          message = 'å·²æ”¶è—';
          break;
        case 'copy':
          message = 'å›¾ç‰‡å·²å¤åˆ¶';
          break;
      }
      
      // æ˜¾ç¤ºæ“ä½œåé¦ˆ
      progressLabel.textContent = message;
      hideWechatMenu();
      
      // 2ç§’åé‡ç½®çŠ¶æ€
      setTimeout(() => {
        progressLabel.textContent = 'ç­‰å¾…é•¿æŒ‰';
      }, 2000);
    }

    // ç»‘å®šé•¿æŒ‰äº‹ä»¶åˆ°æ”¯ä»˜æŒ‰é’®
    function bindPressToPayButton(){
      // Touch
      payBtn.addEventListener('touchstart', (e)=>{ 
        if (!isExpired) {
          e.preventDefault(); 
          startPress(); 
        }
      });
      payBtn.addEventListener('touchend', (e)=>{ 
        if (!isExpired) {
          e.preventDefault(); 
          cancelPress(); 
        }
      });
      payBtn.addEventListener('touchmove', (e)=>{ 
        if (!isExpired) {
          // å¦‚æœæƒ³åœ¨ç§»åŠ¨æ—¶å–æ¶ˆï¼Œå¯åˆ¤æ–­ç§»åŠ¨è·ç¦»
        }
      });

      // Mouse
      payBtn.addEventListener('mousedown', (e)=>{ 
        if (!isExpired) {
          e.preventDefault(); 
          startPress(); 
        }
      });
      window.addEventListener('mouseup', (e)=>{ 
        if(pressTimer && !isExpired) cancelPress(); 
      });

      // ç‚¹å‡»è§¦å‘ï¼ˆçŸ­æŒ‰ï¼‰ä¹Ÿå¯ä»¥ç»™å‡ºåé¦ˆ
      payBtn.addEventListener('click', (e)=>{ 
        if (!isExpired) {
          e.preventDefault(); 
          progressLabel.textContent = 'è¯·é•¿æŒ‰3ç§’è¯†åˆ«æ”¯ä»˜';
          setTimeout(() => progressLabel.textContent = 'ç­‰å¾…é•¿æŒ‰', 1500);
        }
      });
    }

    // æ˜¾ç¤ºçŠ¶æ€æç¤º
    function showStatus(message, type) {
      // ç®€å•çš„çŠ¶æ€æç¤º
      console.log(`${type}: ${message}`);
    }

    // å›¾ç‰‡åŠ è½½é”™è¯¯å¤„ç†
    guideImage.addEventListener('error', ()=>{
      guideImage.src = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="800" height="400"><rect fill="#222" width="100%" height="100%"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#999" font-size="20">å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œç‚¹å‡»åˆ·æ–°äºŒç»´ç </text></svg>');
    });

    // ç›‘å¬localStorageå˜åŒ–ï¼Œå®æ—¶æ›´æ–°å›¾ç‰‡å’Œå€’è®¡æ—¶
    window.addEventListener('storage', (e) => {
      if (e.key === 'imageUrl' || e.key === 'countdownSeconds' || e.key === 'configSaveTime') {
        if (e.key === 'imageUrl') {
          setImageSource();
        }
        if (e.key === 'countdownSeconds' || e.key === 'configSaveTime') {
          // é‡æ–°åˆå§‹åŒ–å€’è®¡æ—¶
          initCountdown();
        }
      }
    });

    // ç»‘å®šé•¿æŒ‰äº‹ä»¶åˆ°æ”¯ä»˜æŒ‰é’®
    bindPressToPayButton();

    // åˆå§‹åŒ–å›¾ç‰‡å’Œå€’è®¡æ—¶
    setImageSource();
    initCountdown();
  </script>
</body>
</html>
